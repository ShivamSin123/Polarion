#set ($colorScheme = "SiemensColors")
## ============================================================================================================================================================
##  @Version=01@
##  Design FMEA Report
##  Dependencies - This report has dependency on extension "com.polarion.pso.ws.rest_1.5.6" and widget "ExportExcelButton"
## ## ----------------------------------------------------------------------------------------------------------------------------------------------------------
##  Date                      Author              Version             Reason for Change
## ----------------------------------------------------------------------------------------------------------------------------------------------------------
##  10-Mar-2022              GDN - Sayali         	1             Initial Creation
##  
##  11-Apr-2022              PSO - Dano     		1.1           Added var $colorScheme to switch table header color scheme
##
##  12-Apr-2022              PSO - Teerawat     	1.2           Fixed link direction lookup for risk record when calculating highest risk index
##
##  29-Aug-2022              GDN - Abhishek         1.3           Added new Macros and edited column rendering sequence and calculations as per j&j requirements
## ============================================================================================================================================================

## #set ($colorScheme = "SiemensColors") (Default is SiemensColors if $colorScheme is blank)
## #set ($colorScheme ="AltColors") ## Uncomment to select alternative color scheme 

##Style for input parameters
 #set($Integer = 0 )
<style>
        .collapsible {
                background-color: #c9e3e9;
                color: #0077b3;
                cursor: pointer;
                padding: 6px;
                width: 100%;
                border: none;
                text-align: left;
                outline: none;
                font-size: 15px;
        }
        .active, .collapsible:hover {
                background-color: #a4d0da;
        }
        .collapsible:after {
                content: '\002B';
                color: #0077b3;
                font-weight: bold;
                font-size: 16px !important;
                float: center;
                margin-left: 15px;
        }
        .active:after {
            content: "\2212";
        }
        .colcontent {
                padding: 0 18px;
                max-height: 0;
                display: contents;
                overflow: visible;
                transition: max-height 0.2s ease-out;
                background-color: #f1f1f1;
        }
        .colcontent1 {
                padding: 0 18px;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.2s ease-out;
                background-color: #f1f1f1;
        }
        #ufmea tr th {
                text-align: center;
        }
        #ufmea tr td {
                height: 20px;
                vertical-align: center;
                text-align: left;
        }
        #ufmea td :hover {
                background-color: #ADD8E6;}
                        
        #ufmea tr td img{
            float: left;
                
        }
        .vertical-header-span {
          writing-mode: vertical-rl;
          transform: rotate(180deg);
          text-align: left;
          max-height: 150px;
            min-width: 15px;
          color: white;
        }

</style>

#set($radioId = $!urlParameters.selectedRadioId.trim())

##Script for generate report using selected input parameters
<script>

        //Function to generate report using selected input parameters for current revision
        function generateReport() {
        try {
                var getUrl = window.location;

                var baseUrl = getUrl.protocol + "//" + getUrl.host + "/";
                var url;
                var baselineRev="";
                var spacePath = '$page.reference.spaceReference.spacePath';
                var baselineRev = '$trackerService.getDataService().getCurrentBaselineRevision()';

                if (!isNaN(baselineRev)) {
                        if (spacePath == '_default') {
                           url = baseUrl + 'polarion/#/baseline/' + baselineRev + '/project/$page.reference.projectId/wiki/$page.reference.name'; }
                        else {
                           url = baseUrl + 'polarion/#/baseline/' + baselineRev + '/project/$page.reference.projectId/wiki/$page.reference.spaceReference.spacePath/$page.reference.name'; }
                } else {
                if (spacePath === '_default') {
                                url = baseUrl + 'polarion/#/project/$page.reference.projectId/wiki/$page.reference.name'; }
                        else {
                                url = baseUrl + 'polarion/#/project/$page.reference.projectId/wiki/$page.reference.spaceReference.spacePath/$page.reference.name'; }
                }
                if (spacePath === '_default') {
                                url = baseUrl + 'polarion/#/project/$page.reference.projectId/wiki/$page.reference.name'; }
                        else {
                                url = baseUrl + 'polarion/#/project/$page.reference.projectId/wiki/$page.reference.spaceReference.spacePath/$page.reference.name'; }
                var selectedIndex =  document.getElementById("docdropdown").selectedIndex;
                var docName = document.getElementById("docdropdown").options[selectedIndex].value.trim();

                if ( docName.trim().length === 0 )
                {
                   alert("Select a Document or check All Risk Items to generate report");
                   return;
                }

                var readOnlyReport = "no";
                if ( jQuery('#readOnly').prop( 'checked' ) )
                {
                   readOnlyReport = "yes";
                }

                var autoReload = "yes";
                if ( jQuery('#autoReload').prop( 'checked' ) )
                {
                   autoReload = "yes";
                }
                else
                {
                   autoReload = "no";
                }

                var autoHide = "no";
                if ( jQuery('#autoHide').prop( 'checked' ) )
                {
                   autoHide = "yes";
                }
                else
                {
                   autoHide = "no";
                }

                var myRow = "no";
                if ( jQuery('#myRow').prop( 'checked' ) )
                {
                   myRow = "yes";
                }
                else
                {
                   myRow = "no";
                }
                //var revision = window.location.href.split('revid=')[1] ? window.location.href.split('revid=')[1] : '';
                var revision="";
                var parameters = '?';
                // TODO - see more baselineRev and improve below code
                if (!isNaN(baselineRev)) {
                        parameters += 'revid=' + baselineRev + '&docName=' + docName + '&readOnly=' + readOnlyReport + '&autoReload=' + autoReload + '&autoHide=' + autoHide + '&newWiId=';
                } else {
                        parameters += 'docName=' + docName + '&readOnly=' + readOnlyReport + '&autoReload=' + autoReload + '&autoHide=' + autoHide + '&myRow=' + myRow + '&newWiId=';
                }
                //parameters += 'docName=' + docName + '&readOnly=' + readOnlyReport + '&autoReload=' + autoReload + '&autoHide=' + autoHide + '&myRow=' + myRow + '&newWiId=';
                // Post
                window.open(url+parameters, "_parent");

          } catch (e) {
                 console.log(e);
                 alert(e);
          }
        }

        //Function to generate report using selected input parameters for baseline revision
        function generateReport1(baseRevision) {
        try {
                var getUrl = window.location;
                var baseUrl = getUrl.protocol + "//" + getUrl.host + "/";
                var url;
                var baselineRev="";
                var spacePath = '$page.reference.spaceReference.spacePath';
                var baselineRev = baseRevision;
        var selectedRadioId= "regular" + baselineRev;
        var selectedRadioButton= document.getElementById(selectedRadioId);
         
                if (spacePath === '_default') {
                                url = baseUrl + 'polarion/#/project/$page.reference.projectId/wiki/$page.reference.name'; }
                        else {
                                url = baseUrl + 'polarion/#/project/$page.reference.projectId/wiki/$page.reference.spaceReference.spacePath/$page.reference.name'; }

                var selectedIndex =  document.getElementById("docdropdown").selectedIndex;
                var docName = document.getElementById("docdropdown").options[selectedIndex].value.trim();

                if ( docName.trim().length === 0 )
                {
                   alert("Select a Document or check All Risk Items to generate report");
                   return;
                }

                var readOnlyReport = "no";
                if ( jQuery('#readOnly').prop( 'checked' ) )
                {
                   readOnlyReport = "yes";
                }

                var autoReload = "yes";
                if ( jQuery('#autoReload').prop( 'checked' ) )
                {
                   autoReload = "yes";
                }
                else
                {
                   autoReload = "no";
                }

                var autoHide = "no";
                if ( jQuery('#autoHide').prop( 'checked' ) )
                {
                   autoHide = "yes";
                }
                else
                {
                   autoHide = "no";
                }

                var myRow = "no";
                if ( jQuery('#myRow').prop( 'checked' ) )
                {
                   myRow = "yes";
                }
                else
                {
                   myRow = "no";
                }

                var revision = window.location.href.split('revid=')[1] ? window.location.href.split('revid=')[1] : '';
        
                var parameters = '?';
                var selection="";
                selection= selectedRadioId;
                // TODO - see more baselineRev and improve below code
                if (!isNaN(baselineRev)) {
                        parameters += 'baselinerevid=' + baselineRev + '&docName=' + docName + '&readOnly=' + readOnlyReport + '&autoReload=' + autoReload + '&autoHide=' + autoHide  + '&myRow=' + myRow + '&selectedRadioId=' +  selection + '&newWiId=';
                } else {
                        parameters += 'baselinerevid=' + revision + '&docName=' + docName + '&readOnly=' + readOnlyReport + '&autoReload=' + autoReload + '&autoHide=' + autoHide  + '&myRow=' + myRow + '&selectedRadioId=' +  selection + '&newWiId=';
                }
                  // Post
                window.open(url+parameters, "_parent");
          } catch (e) {
                 console.log(e);
                 alert(e);
          }
        }
    var coll = document.getElementsByClassName("collapsible");
        var i;
        for (i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                        this.classList.toggle("active");
                        var content = this.nextElementSibling;
                        if (content.style.maxHeight) {
                                content.style.maxHeight = null;
                        } else {
                                content.style.maxHeight = content.scrollHeight + "px";
                        }
            } );
        }

</script>

##Document type
#set($docType = "FMEA")

##Global variable declaration
#set($projectID = $page.reference.projectId)
#set($trkrProject = $trackerService.getTrackerProject($projectID))
#set($project = $trackerService.getProjectsService().getProject($projectID))
#set($prjRevision =$project.getRevision())
#set($lastRevisionNumber = "")

## Harm fields
#set($harmSeverity = "harmSeverity")

##Workitem types
#set($WORKITEM_TYPE_FUNCTION = "function")
#set($WORKITEM_TYPE_FAILURE_MODE = "failureMode")
#set($WORKITEM_TYPE_DESIGN_REQUIREMENT = "designRequirement")

## Hazardous Situation fields
#set($hazardSourceOfHS = "hazardSourceOfHS")
#set($foreseeableSequenceOfEvents = "foreseeableSequenceOfEvents")
#set($premitigationHSProbability = "premitigationHSProbability")
#set($premitigationFMOccurrence = "premitigationFMOccurrence")
#set($postmitigationFMOccurrence = "postmitigationFMOccurrence")
#set($effectOfFailure = "effectOfFailure")
#set($postmitigationHSProbability = "postmitigationHSProbability")
#set($rationale = "rationale")

## Risk Record fields
#set($premitigationHarmProbability = "premitigationHarmProbability")
#set($premitigationRPL_RI = "premitigationRPL_RI")
#set($postmitigationRPL_RI = "postmitigationRPL_RI")
#set($postmitigationHarmProbability = "postmitigationHarmProbability")
#set($p2Factor = "p2Factor")
#set($mitigationEffective = "mitigationEffective")

## global variables for Link Roles
#set($linkrole_Causes = "causes")
#set($linkrole_Detects = "detects")
#set($linkrole_Mitigates = "mitigates")
#set($linkrole_HasRiskRecord ="hasRiskRecord")
#set($linkrole_Controls ="controls")
#set($linkrole_Refines ="refines")
#set($linkrole_Classifies = "classifies")
#set($linkrole_Evaluates = "evaluates")

##Work Item Maps
#set($fmeS = $objectFactory.newMap())
#set($cfdS = $objectFactory.newMap())
#set($fmeCfdMap = $objectFactory.newMap())
#set($fmeRowSpanMap = $objectFactory.newMap())
#set($cfdFaSizeMap = $objectFactory.newMap())
#set($cfdFaMap = $objectFactory.newMap())
#set($cfsrMMap = $objectFactory.newMap())
#set($uecfMap = $objectFactory.newMap())
#set($cfsrMap = $objectFactory.newMap())
#set($cfsrSizeMap = $objectFactory.newMap())
#set($blMap = $objectFactory.newMap())
#set($int = 0)
#set($baseRevision =""        )
#set($bName = "")        

##Creation of input parameters block
<div style="pd4ml-display: none;">
<left>
        <button type="button" class="collapsible">Provide inputs to generate Risk report</button>

        #if($urlParameters.size() ==0 )
        <div class="colcontent">
        #else
                <div class="colcontent1">
        #end
                Select a Document from the list below and click on 'Generate Report' button to view FMEA report <br>
                <table>
                        <tr><td align="right"><label>Document:</label></td><td>
                        <select id="docdropdown">
                                <option value="allFmeaItems">All FMEA Items</option>
                                ##Query to get documents of selected doctype
                                #set($docQuery = "select distinct DOC.C_URI from polarion.module DOC inner join polarion.project PRJ ON DOC.FK_Project = PRJ.C_PK where DOC.C_Type = '$docType' AND PRJ.C_ID='$page.reference.projectId'")

                                #foreach ($imodule in $trackerService.getDataService().sqlSearch($docQuery))
                                        #if(!$imodule.isUnresolvable())
                                                #set($folder = $imodule.getFolder())
                                                #if($folder.getName()!="Templates")
                                                        <option value="$folder.getName()/$imodule.getModuleName()">$folder.getTitleOrName() / $imodule.getTitleOrName()</option>
                                                #end
                                        #end
                                #end
                        </select></td></tr>
                        <div id="checkbox-container">
                        <tr><td></td><td><div><input type="checkbox" class="save-cb-state" id="readOnly" value="no"> Read only report</div></td></tr>
                        <tr><td></td><td><div><input type="checkbox" class="save-cb-state" id="autoReload" value="yes" checked="checked"> Auto reload report after Item creation</div></td></tr>
                        <tr><td></td><td><div><input type="checkbox" class="save-cb-state" id="autoHide" value="no"> Collapse Navigation Panel</div></td></tr>
                        ##<tr><td></td><td><div><input type="checkbox"  class="save-cb-state" id="myRow" value="dontShow" onchange="hide_show_table(this.id);"> Hide Row</div></td></tr>
                        <tr><td></td><td><div><input type="checkbox"  class="save-cb-state" id="myRow" value="no" > Show Refined Requirements </div></td></tr>
                        
                        </div>
                </table>
                <br>
                <left><div style="pd4ml-display: none ; "><button onclick="generateReport()" class="reportbutton" VALIGN=MIDDLE>Generate Report</button></div></left><br>
                <br>
        </div>                
</left>
</div>
<br>

## Macro for creation of linking dialog
#macro(renderLinkingDialog)
        #set($workItemTypeEnum = $trackerService.getTrackerProject($projectID).getWorkItemTypeEnum().getAllOptions())
        #set($linkRoleEnum = $trackerService.getTrackerProject($projectID).getWorkItemLinkRoleEnum().getAllOptions())
        #set($workItemLinks = "")
        #set($linkOppositeNameList = "")
        #set($workItemAllLinkRoles = "")
        ##set($workItemTypeArray = [])
        #set($workItemLinkRoleList = "")
        ## below forloop to listdown all opposite names of a link in order to checktheDirection of linking from dropdown
        #foreach($linkRole in $linkRoleEnum)
          #set($linkOppositeNameList = $linkOppositeNameList.concat("${linkRole.getOppositeName()}:"))
        #end

        ##creating a string of all possible linkroles for each wi type combination
        #foreach($workItemType in $workItemTypeEnum)
          #set($workItemLinkRoleList = $workItemLinkRoleList.concat(":${workItemType.id}:"))
          #set($workItemTypeArray = [])
          #foreach($wiType in $workItemTypeEnum)
                #set($workItemLinks = $workItemLinks.concat(":${workItemType.id}"))
                #set($workItemLinks = $workItemLinks.concat(":${wiType.id}:"))

                #foreach($linkRole in $linkRoleEnum)
                  #set($stringLinkRole = "")
                  #if(${wiType.id} == ${workItemType.id})  ## if the from & to WI type are same then the linkRole could to be both in opposite/back or direct link
                        #if($linkRole.isAllowed($workItemType, $wiType))
                          #set($oppositeName = $linkRole.getOppositeName())

                          #set($workItemLinks = $workItemLinks.concat("${linkRole.id}="))
                          #set($workItemLinks = $workItemLinks.concat("${linkRole.getName()};"))
                          ## concatinating opposite names to the string
                          #set($workItemLinks = $workItemLinks.concat("${linkRole.id}="))
                          #set($workItemLinks = $workItemLinks.concat("${oppositeName};"))
                          ##
                          #set($stringLinkRole = $stringLinkRole.concat("${linkRole.id}="))
                          #set($stringLinkRole = $stringLinkRole.concat("${linkRole.getName()}"))
                          #set($void = $workItemTypeArray.add($stringLinkRole))
                        #end
                  #else
                        #if($linkRole.isAllowed($workItemType, $wiType))      ## if from wi type is different than To Wi type then link role list should only show forward option
                          ##set($oppositeNameNew = $linkRole.getOppositeName())
                          #set($workItemLinks = $workItemLinks.concat("${linkRole.id}="))
                          #set($workItemLinks = $workItemLinks.concat("${linkRole.getName()};"))
                          ####
                          #set($stringLinkRole = $stringLinkRole.concat("${linkRole.id}="))
                          #set($stringLinkRole = $stringLinkRole.concat("${linkRole.getName()}"))
                          #set($void = $workItemTypeArray.add($stringLinkRole))
                          ##set($workItemLinks = $workItemLinks.concat("${linkRole.id}="))
                          ##set($workItemLinks = $workItemLinks.concat("${oppositeNameNew};"))
                        #elseif($linkRole.isAllowed($wiType, $workItemType))   ## concatination the swaped i.e to wi to From wi type for opposite linking case
                          #set($oppositeNameNA = $linkRole.getOppositeName())
                          #set($workItemLinks = $workItemLinks.concat("${linkRole.id}="))
                          #set($workItemLinks = $workItemLinks.concat("${oppositeNameNA};"))
                          ##
                          #set($stringLinkRole = $stringLinkRole.concat("${linkRole.id}="))
                          #set($stringLinkRole = $stringLinkRole.concat("${oppositeNameNA}"))
                          #set($void = $workItemTypeArray.add($stringLinkRole))
                        #end
                  #end
                #end ## end of linkROle for loop
                #set($workItemLinks = $workItemLinks.concat("+++"))
          #end  ## end of sub WI type  forloop
          #foreach($linkRole in $workItemTypeArray)
                  #set($workItemLinkRoleList = $workItemLinkRoleList.concat("${linkRole};"))
          #end
          #set($workItemLinkRoleList = $workItemLinkRoleList.concat("+++"))
        #end  ## end of main WI type for loop

##style for table
        <style>
        .hover-highlight:hover {
                background-color: #ccf2ff !important;
                padding: 10px;
        }
    .button {
    appearance: auto;
    -webkit-writing-mode: horizontal-tb !important;
    font-style: ;
    
    font-variant-ligatures: ;
    font-variant-caps: ;
    font-variant-numeric: ;
    font-variant-east-asian: ;
    font-weight: ;
    font-stretch: ;
    font-size: ;
    font-family: ;
    text-rendering: auto;
    color: -internal-light-dark(black, white);
    letter-spacing: normal;
    word-spacing: normal;
    line-height: normal;
    text-transform: none;
    text-indent: 0px;
    text-shadow: none;
    display: inline-block;
    text-align: left;        
    align-items: flex-start;
    cursor: default;
    box-sizing: border-box;
    background-color: -internal-light-dark(rgb(239, 239, 239), rgb(59, 59, 59));
    margin: 0em;
    padding: 1.4px 3px;
    border-width: 1px;
    border-style: outset;
    border-color: -internal-light-dark(rgb(118, 118, 118), rgb(133, 133, 133));
    border-image: initial;
        }
        .polarion-rpw-table-cell-highlight
        {
                background-color:  #B7E9F7
        }
        .polarion-sidebar-click-item {
                cursor: pointer;
                padding-top: 2px;
                font-size: smaller;
                width: 20px;
                pd4ml-display: none;
                font-family: Arial, Helvetica, sans-serif !important;
                appearance: button;
                -webkit-writing-mode: horizontal-tb !important;
                text-rendering: auto;
                color: -internal-light-dark(buttontext, rgb(170, 170, 170));
                letter-spacing: normal;
                word-spacing: normal;
                text-transform: none;
                text-indent: 0px;
                text-shadow: none;
                display: inline-block;
                text-align: center;
                align-items: flex-start;
                cursor: default;
                background-color: #efefef;
                box-sizing: border-box;
                margin: 0em;
                font: 9.8px Arial;
                padding: 1.4px 2px;
                border-width: 1px;
                border-style: outset;
                border-color: #767676;
                border-image: initial;
                border-radius: 2px;
        }
        .polarion-sidebar-click-item:hover {
            border-color:#4a4a4a;
                background-color:#c3c3c3;
        }
        .polarion-rp-column-container{
                border: 1px solid transparent;
                padding: 5px;
                outline: 0;
                overflow: unset;
        }
        #polarion_LinkPanel_title {
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                font-size: 16px;
                color: #565656;
                text-shadow: 1px 1px 0 white;
                font-weight: bold;
                padding-left: 3px;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 250px;
        }
        #polarion_LinkPanel_fromLabel{
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                font-size: 11px;
                color: #888888;
                padding-left: 5px;
                padding-top: 2px;
                min-height: 21px;
        }
        #polarion_LinkPanel_toWiId{
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                cursor: pointer;
                color: #565656;
                font-weight: bold;
                white-space: nowrap;
        }
        #polarion_LinkPanel_targetLink{
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                cursor: pointer;
                outline: none;
                color: #565656;
                font-weight: bold;
                width: 97px;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
        }
        .polarion-LinkPanel-popupContainer {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                width: 100%;
        }
        .polarion-RpcPanel-Container {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                width: 100%;
                height: auto;
        }
        .polarion-LinkPanel-superContainer {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                width: 100%;
        }
        .polarion-LinkPanel-problemContainerParent {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                padding: 15px 0px 0px 15px;
                width: 100%;
                display: block;
        }
        .polarion-LinkPanel-problemContainer {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                font-weight: bold;
                background: #FFE599;
                border: 1px solid #D7B960;
                border-radius: 6px;
                color: #996F11;
                padding: 7px;
                width: 100%;
        }
        .polarion-LinkPanel-problemIcon {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-weight: bold;
                color: #996F11;
                font-family: Arial, Helvetica, sans-serif !important;
                padding-right: 5px;
                padding-left: 5px;
        }
        .polarion-LinkPanel-infoContainerParent {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                padding: 15px 0px 0px 15px;
                width: 100%;
                display: block;
        }
        .polarion-LinkPanel-infoContainer {
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                font-size: 11px;
                background: #D1E8FF;
                border: 1px solid #D1E8FF;
                border-radius: 6px;
                color: #0E4A90;
                padding: 5px;
                width: 100%;
        }
        .polarion-LinkPanel-container {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                width: 100%;
                padding: 15px 0px 15px 15px;
        }
        .polarion-LinkPanel-topContainer {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                width: 100%;
        }
        .polarion-LinkPanel-sourcePanel {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                padding: 2px 2px 4px 2px;
                width: 100%;
        }
        .polarion-LinkActions {
                cursor: pointer;
                font-size: 11px;
                width: 15px;
                padding: 0px 2px;
                text-align: bottom;
                pd4ml-display: none;
        }
        .polarion-LinkActions:hover {
                background-color: #cccccc;
                opacity: 1;
        }
        .polarion-LinkActions:after{
            opacity: 1;
        }
        .link_image {
                width: 12px;
                height: 12px;
                position: relative;
                padding-right: 1px;
                vertical-align: bottom;
        }
        .polarion_LinkPanel_popup_done{
                font-size: 13px;
                font-family: Arial, Helvetica, sans-serif !important;
                text-align: left;
                box-shadow: 0px 0px 6px  #E0DEDE;
                border-radius: 6px;
                width: 380px;
                opacity: 1;
                min-height: 148px;
                -webkit-transition: box-shadow 2s linear;
                background: #E1F0FF;
                border: 1px solid #B0CAE4;
                left: 1278px;
                top: 382px;
        }
        .polarion_LinkPanel_popup {
                font-size: 13px;
                font-family: Arial, Helvetica, sans-serif !important;
                text-align: left;
                background: #F5F5F5;
                border: 1px solid #C6C6C6;
                box-shadow: 0px 0px 6px  #E0DEDE;
                border-radius: 6px;
                width: 380px;
                opacity: 1;
                min-height: 148px;
                -webkit-transition: box-shadow 2s linear;
        }
        .polarion_LinkPanel_popup_done_final{
                font-size: 13px;
                font-family: Arial, Helvetica, sans-serif !important;
                text-align: left;
                box-shadow: 0px 0px 6px  #E0DEDE;
                border-radius: 6px;
                width: 380px;
                opacity: 1;
                min-height: 148px;
                -webkit-transition: box-shadow 2s linear;
                background: #ECFFD6;
                border: 1px solid #B9DB90;
        }
        #add_WI_Link {
                position: fixed;
                z-index: 9;
        }
        #add_WI_Linkheader{
                cursor: move;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
        }
        .popupContent {
                font-size: 13px;
                text-align: left;
                visibility: visible;
                font-family: Arial, Helvetica, sans-serif !important;
                height: 100%;
        }
        .polarion-createAction {
                cursor: pointer;
                padding-top: 1px;
                font-size:smaller;
                width:63px;
        }

        .polarion-tablePlus-image{
                width:12px;
                height:12px;
                position:relative;
                left:4px;
                vertical-align: bottom;
        }
        .polarion-link-image{
                width:12px;
                height:12px;
                position:relative;
                left:4px;
                vertical-align: bottom;
        }
        </style>
    <div id="add_WI_Link" style="left: 900px; top: 90px; display: none;">
         <div align="center" style="display: none;" id="loadingDiv">
                <table>
                        <tr>
                                <td align="center" valign="middle" style="width: 100%;">
                                <img src="/polarion/ria/images/progress.gif" alt="progress">
                                </td>
                        </tr>
                        <tr>
                                <td>Please Wait...</td>
                        </tr>
                </table>
         </div>
         <div  id="add_WI_Linkheader" class="popupContent">
          <table cellspacing="0" cellpadding="0" class="polarion-LinkPanel-popupContainer">
                <tbody>
                  <tr>
                   <td>
                        <div>
                         <table>
                          <tbody>
                           <tr>
                                 <td align="left" style="vertical-align: top;">
                                        <table  id="polarion_LinkPanel_problem" style="display: none" cellspacing="0" cellpadding="0" class="polarion-LinkPanel-problemContainerParent" style="">
                                           <tbody>
                                                  <tr>
                                                         <td align="left" style="vertical-align: middle;">
                                                                <table cellspacing="0" cellpadding="0" class="polarion-LinkPanel-problemContainer">
                                                                   <tbody>
                                                                          <tr>
                                                                                 <td align="left" style="vertical-align: middle;"><img src="/polarion/ria/images/linking/problem.png" class="polarion-LinkPanel-problemIcon"></td>
                                                                                 <td align="left" style="vertical-align: middle;">
                                                                                        <div class="gwt-Label" style="">No link roles defined for Selected workitem types</div>
                                                                                 </td>
                                                                          </tr>
                                                                   </tbody>
                                                                </table>
                                                         </td>
                                                  </tr>
                                           </tbody>
                                        </table>
                                 </td>
                           </tr>
                           <tr>
                                <td align="left" style="vertical-align: top;">
                                 <div class="polarion-RpcPanel-Container" style="height: auto;">
                                  <table cellspacing="0" cellpadding="0" class="polarion-LinkPanel-container" >
                                        <tr>
                                          <td align="left" style="vertical-align: top;">
                                                <table cellspacing="0" cellpadding="0" class="polarion-LinkPanel-topContainer">
                                                  <tbody>
                                                        <tr>
                                                         <td align="left" style="vertical-align: top;">
                                                           <table cellspacing="0" cellpadding="0">
                                                                 <tbody>
                                                                         <tr>
                                                                                <td align="left" height="100%" style="vertical-align: top;">
                                                                                   <div id="polarion_LinkPanel_title"></div>
                                                                                </td>
                                                                         </tr>
                                                                         <tr>
                                                                           <td align="left" height="100%" style="vertical-align: top;">
                                                                                  <table cellspacing="0" cellpadding="0" class="polarion-LinkPanel-sourcePanel">
                                                                                         <tbody>
                                                                                                <tr>
                                                                                                   <td align="left" width="16px" style="vertical-align: middle;"><img src="" id="polarion_LinkPanel_fromWiIcon" style="width: 16px;"></td>
                                                                                                   <td align="left" style="vertical-align: middle;">
                                                                                                          <div id="polarion_LinkPanel_fromLabel" title=""></div>
                                                                                                   </td>
                                                                                                </tr>
                                                                                         </tbody>
                                                                                  </table>
                                                                                </td>
                                                                         </tr>
                                                                  </tbody>
                                                                </table>
                                                          </td>
                                                        <td align="left" style="vertical-align: top;">
                                                           <table cellspacing="0" cellpadding="0">
                                                                  <tbody>
                                                                         <tr>
                                                                                <td align="left" style="vertical-align: middle;">
                                                                                   <div id="polarion_Button_save" role="button" title="Save" tabindex="0" style="display: none;"><img src="/polarion/ria/images/linking/save_link.png"  id="createLinks"></div>
                                                                                </td>
                                                                                <td align="left" style="vertical-align: middle;">
                                                                                   <div class="polarion-LinkPanel-button polarion-Button-shared" role="button" title="Confirm" tabindex="0" aria-hidden="true" style="display: none;"><img src="/polarion/ria/images/linking/confirm_link.png" class="gwt-Image"></div>
                                                                                </td>
                                                                                <td align="left" style="vertical-align: middle;"><img src="/polarion/ria/images/linking/confirmed.png" class="gwt-Image" aria-hidden="true" style="display: none;"></td>
                                                                                <td align="left" style="vertical-align: middle;">
                                                                                   <div id="polarion_Button_saved" role="button" title="Saved" tabindex="0" style="display: none;"><img src="/polarion/ria/images/linking/saved.png"></div>
                                                                                </td>
                                                                         </tr>
                                                                  </tbody>
                                                           </table>
                                                        </td>
                                                 </tr>
                                                </tbody>
                                          </table>
                                         </td>
                                        </tr>
                                        <tr>
                                          <td align="left" style="vertical-align: top;">
                                                <table cellspacing="0" cellpadding="0">
                                                  <tbody>
                                                        <tr>
                                                                  <td align="left" style="vertical-align: top;">
                                                                         <table cellspacing="0" cellpadding="0" class="polarion-LinkPanel-linkAreaContainer">
                                                                                <tbody>
                                                                                   <tr>
                                                                                          <td align="left" height="100%" style="vertical-align: top;">
                                                                                                 <table cellspacing="0" cellpadding="0" class="polarion-LinkPanel-linkContainer" style="border-collapse: separate; border-spacing: 2px;">
                                                                                                        <tbody>
                                                                                                           <tr>
                                                                                                                  <td align="left" width="26px" style="vertical-align: top;"><img src="/polarion/ria/images/linking/arrow_down.png" id="polarion-LinkPanel-linkArrow"></td>
                                                                                                                  <td align="left" style="vertical-align: top;">
                                                                                                                         <table cellspacing="0" cellpadding="0">
                                                                                                                                <tbody>
                                                                                                                                   <tr>
                                                                                                                                          <td align="left" style="vertical-align: top;">
                                                                                                                                                 <table cellspacing="0" cellpadding="0" class="polarion-LinkPanel-linkDetailsContainer">
                                                                                                                                                        <tbody>
                                                                                                                                                           <tr>
                                                                                                                                                                 <td align="left" style="vertical-align: middle;">
                                                                                                                                                                        <table cellspacing="0" cellpadding="0">
                                                                                                                                                                           <tbody>
                                                                                                                                                                                  <tr>
                                                                                                                                                                                         <td align="left" style="vertical-align: top;">
                                                                                                                                                                                           <select id="linkRoles" style="width: 130px" onchange="checkLinkDirection();">
                                                                                                                                                                                                 <option> select_Link_Role </option>
                                                                                                                                                                                           </select>
                                                                                                                                                                                         </td>
                                                                                                                                                                                  </tr>
                                                                                                                                                                           </tbody>
                                                                                                                                                                        </table>
                                                                                                                                                                  </td>
                                                                                                                                                                  <td align="left" width="100%" style="vertical-align: middle;">
                                                                                                                                                                          <table cellspacing="0" cellpadding="0" style="border-collapse: separate; border-spacing: 2px;">
                                                                                                                                                                                 <tbody>
                                                                                                                                                                                        <tr>
                                                                                                                                                                                           <td align="left" style="vertical-align: middle;">
                                                                                                                                                                                                  <div id="polarion_LinkPanel_selectWorkitem" style="display:none" role="button" tabindex="0"><img style="cursor: pointer;" onclick="workItemPicker()" src="/polarion/ria/images/control/select_wi.gif" title="Select Work Item" ></div>
                                                                                                                                                                                           </td>
                                                                                                                                                                                           <td align="left" style="vertical-align: top;">
                                                                                                                                                                                                 <input type="search" list="selectTargetWI" id="searchTargetWI" placeholder="search" name="searchTargetWI" onsearch="createLink(this)" style="width: 125px; display:none"/>
                                                                                                                                                                                                 <datalist id="selectTargetWI">
                                                                                                                                                                                                   <option>select target WI </option>
                                                                                                                                                                                                 </datalist>
                                                                                                                                                                                           </td>
                                                                                                                                                                                           <td align="left" style="vertical-align: middle;"><img src="" id="polarion_LinkPanel_toWiIcon"></td>
                                                                                                                                                                                           <td align="left" style="vertical-align: middle;">
                                                                                                                                                                                                  <div id="polarion_LinkPanel_targetLink polarion-Button-shared" role="button" tabindex="0"><span id="polarion_LinkPanel_toWiId"></span></div>
                                                                                                                                                                                           </td>
                                                                                                                                                                                        </tr>
                                                                                                                                                                                 </tbody>
                                                                                                                                                                          </table>
                                                                                                                                                                   </td>
                                                                                                                                                           </tr>
                                                                                                                                                        </tbody>
                                                                                                                                                 </table>
                                                                                                                                          </td>
                                                                                                                                   </tr>
                                                                                                                                   <tr>
                                                                                                                                          <td align="left" height="100%" style="vertical-align: top;">
                                                                                                                                                 <table cellspacing="0" cellpadding="0" class="polarion-LinkPanel-savedLinksContainer" aria-hidden="true" style="display: none;">
                                                                                                                                                        <tbody></tbody>
                                                                                                                                                 </table>
                                                                                                                                          </td>
                                                                                                                                   </tr>
                                                                                                                                </tbody>
                                                                                                                         </table>
                                                                                                                  </td>
                                                                                                           </tr>
                                                                                                        </tbody>
                                                                                                 </table>
                                                                                         </td>
                                                                                 </tr>
                                                                          </tbody>
                                                                   </table>
                                                                </td>
                                                         </tr>
                                                         <tr>
                                                                <td align="left" style="vertical-align: top;">
                                                                        <table cellspacing="0" cellpadding="0" id="polarion-LinkPanel-hintContainer" style="display: block;">
                                                                           <tbody>
                                                                                  <tr>
                                                                                         <td align="left" style="vertical-align: middle;"><img src="/polarion/ria/images/linking/cursor.png" class="polarion-LinkPanel-hintIcon"></td>
                                                                                         <td align="left" style="vertical-align: middle;">
                                                                                                <div class="polarion-LinkPanel-hint">Click&nbsp;<img src="/polarion/ria/images/linking/link.png" style="vertical-align: middle;"> on different Work Item to complete the link.<br> Or Select workitem from list and click on <i>Enter</i></div>
                                                                                         </td>
                                                                                  </tr>
                                                                           </tbody>
                                                                        </table>
                                                                </td>
                                                          </tr>
                                                        </tbody>
                                                  </table>
                                                </td>
                                          </tr>
                                  </table>
                                         </div>
                                </td>
                           </tr>
                          </tbody>
                         </table>
                         </div>
                        </td>
                        <td id="add_WI_Linkdragable" align="left" style="vertical-align: top;">
                          <table cellspacing="0" cellpadding="0">
                                 <tbody>
                                        <tr>
                                           <td align="left" style="vertical-align: top;">
                                                  <div class="polarion-ClientButton polarion-Button-shared polarion-LinkPanel-closeButton" role="button" tabindex="0"><img src="/polarion/ria/images/linking/close.png" class="close"></div>
                                           </td>
                                        </tr>
                                 </tbody>
                          </table>
                        </td>
                  </tr>
                </tbody>
          </table>
         </div>
        </div>
#end
##Macro to get risk record workitems linked to harm and hazardous situation
#macro (checkHarmAndHSforRR $rr $harmFlag $hsFlag)
         #set ($hmItemQuery = "type:harm AND linkedWorkItems:hasRiskRecord=$rr.getProject().getId()/$rr.getId()")
         #set ($hsWorkItemsHm = $trackerService.queryWorkItems($hmItemQuery, "id") )
         #set ($harmFlag = $hsWorkItemsHm.size())

         #set ($hsItemQuery = "type:hazardousSituation AND linkedWorkItems:hasRiskRecord=$rr.getProject().getId()/$rr.getId()")
         #set ($hsWorkItems = $trackerService.queryWorkItems($hsItemQuery, "id") )
         #set ($hsFlag = $hsWorkItems.size())
#end

##Macro to render workitem in table
#macro(RenderWorkItem $workItem )
#if($workItem && !$workItem.isUnresolvable() )
        ##workitem with revision
    #if(!$lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
        #set($baselineString = $lastRevisionNumber)
                #if(!$workItem.getRevision())
                        #set($wiRenderer =$transaction.workItems().getBy().revision($baselineString).oldApiObject($workItem))
                        #set($wiLink = $transaction.context().createPortalLink().project("$wiRenderer.getReference().projectId()").workItem("$wiRenderer.getReference().id()").toEncodedRelativeUrl())
                        #set($icon = $workItem.getType().getProperty("iconURL") )
                        #set($hazardIcon = "<img src = $icon>" )
                        #set($wiID = $wiRenderer.fields().id().get())        
                        #set($wiTitle = $wiRenderer.fields().title().render())
                        <img src="/polarion/ria/images/fixed_revision.gif" style="pd4ml-display:none;">$hazardIcon<a href="$wiLink" target="_blank" title="$wiID $wiTitle">$wiTitle</a>
                #else
                        #set($wiRenderer =$transaction.workItems().getBy().revision($baselineString).oldApiObject($workItem))
                        #set($wiLink = $transaction.context().createPortalLink().project("$wiRenderer.getReference().projectId()").workItem("$wiRenderer.getReference().id()").revision($workItem.getRevision()).toEncodedRelativeUrl())
                        #set($icon = $workItem.getType().getProperty("iconURL") )
                        #set($hazardIcon = "<img src = $icon>" )
                        #set($wiID = $wiRenderer.fields().id().get())        
                        #set($wiTitle = $wiRenderer.fields().title().render())
                        <img src="/polarion/ria/images/fixed_revision.gif" style="pd4ml-display:none;">$hazardIcon<a href="$wiLink" target="_blank" title="$wiID $wiTitle">$wiTitle</a>
                #end
                ##for read only report
        #elseif($readOnlyReport.equals("yes")) ##TM: added for readonly option, no icon
                #if(!$workItem.getRevision())
                        #set($wiRenderer = $transaction.workItems().getBy().oldApiObject($workItem))
                        #set($wiLink = $transaction.context().createPortalLink().project("$wiRenderer.getReference().projectId()").workItem("$wiRenderer.getReference().id()").toEncodedRelativeUrl())
                        #set($wiID = $wiRenderer.fields().id().get())        
                        #set($wiTitle = $wiRenderer.fields().title().render())
                        <a href="$wiLink" target="_blank" title="$wiID $wiTitle">$wiRenderer.fields().title().render().withIcon(false)</a>
                #else
                        #set($wiRenderer = $transaction.workItems().getBy().oldApiObject($workItem))
                        #set($wiLink = $transaction.context().createPortalLink().project("$wiRenderer.getReference().projectId()").workItem("$wiRenderer.getReference().id()").revision($workItem.getRevision()).toEncodedRelativeUrl())
                        #set($wiID = $wiRenderer.fields().id().get())        
                        #set($wiTitle = $wiRenderer.fields().title().render())
                        <a href="$wiLink" target="_blank" title="$wiID $wiTitle">$wiRenderer.fields().title().render().withIcon(false)</a>
                #end
    #else
        ##current revision workitem
       #if(!$workItem.getRevision())
                #set($wiRenderer = $transaction.workItems().getBy().oldApiObject($workItem))
                #set($wiLink = $transaction.context().createPortalLink().project("$wiRenderer.getReference().projectId()").workItem("$wiRenderer.getReference().id()").toEncodedRelativeUrl())
                #set($icon = $workItem.getType().getProperty("iconURL") )
                
                 #set($hazardIcon = "<img src = $icon>" )
                #set($wiID = $wiRenderer.fields().id().get())        
                #set($wiTitle = $wiRenderer.fields().title().render())
                $hazardIcon <a href="$wiLink" target="_blank" title="$wiID $wiTitle">$wiTitle</a>
                #else
                #set($wiRenderer = $transaction.workItems().getBy().oldApiObject($workItem))
                #set($wiLink = $transaction.context().createPortalLink().project("$wiRenderer.getReference().projectId()").workItem("$wiRenderer.getReference().id()").revision($workItem.getRevision()).toEncodedRelativeUrl())
                #set($icon = $workItem.getType().getProperty("iconURL") )
                 #set($hazardIcon = "<img src = $icon>" )
                #set($wiID = $wiRenderer.fields().id().get())        
                #set($wiTitle = $wiRenderer.fields().title().render())
                <img src="/polarion/ria/images/fixed_revision.gif" style="pd4ml-display:none;">$hazardIcon <a href="$wiLink" target="_blank" title="$wiID $wiTitle">$wiTitle</a>
                #end
    #end
#end
#end

##Macro to render workitem's field
#macro(RenderWorkItemField $workItem $field $renderedWI)
#if($workItem && !$workItem.isUnresolvable())
        #if($readOnlyReport.equals("no"))
                #if(!$lastRevisionNumber.equals(""))
                        #set($baselineString = $lastRevisionNumber)
                        #set( $renderedWI = $transaction.workItems().getBy().revision($baselineString).oldApiObject($!workItem).fields().get($field).render().withLinks().openLinksInNewWindow())
                #else
                        #set( $renderedWI = $transaction.workItems().getBy().oldApiObject($!workItem).fields().get($field).render().withLinks().openLinksInNewWindow())
                #end
        #else        ##TM: added for readonly option, no icon
                #if(!$lastRevisionNumber.equals(""))
                        #set($baselineString = $lastRevisionNumber)
                        #set( $renderedWI = $transaction.workItems().getBy().revision($baselineString).oldApiObject($!workItem).fields().get($field).render().withIcon(false).withLinks().openLinksInNewWindow())
                #else
                        #set( $renderedWI = $transaction.workItems().getBy().oldApiObject($!workItem).fields().get($field).render().withIcon(false).withLinks().openLinksInNewWindow())
                #end
        #end
#end
#end

##Macro for creation of link button
#macro(newLinkingButton $wI)
  #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
         #if($wI.can().modify())
                #set($wiId = $wI.getId())
                #set($wiProject = $wI.getProjectId())
                #set($wiProjectName = $wI.getProject().getName())
                #set($wiType = $wI.getType().getId())
                #set($wiTypeIcon = $wI.getType().getProperty("iconURL"))
        
                <button class='polarion-rpw-table-cell-highlight $clickClass' wiId="$wiId" wiProjectName="$wiProjectName" wiProject="$wiProject" wiType="$wiType" iconURL="$wiTypeIcon" onclick="createLink(this);" title="Create Link"><img src="/polarion/ria/images/control/linksScroll.png" style="pd4ml-display:none;"></button>
         #end
   #end
#end

##Macro for creation of new workitem button without custom field
#macro(newWorkItemButton $wiTypeToBeCreated $direction $linkRole $docPathForWi $addAsChildNode $buttonText $plusButtonTooltip $workItemsToLink $fieldValueList)
  #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
     #if($trkrProject.can().createWorkItemOfType($wiTypeToBeCreated))
                #set($wisString = "")
                #set($customField = "")
                #foreach($wi in $workItemsToLink)
                        #set($wisString = $wisString.concat("$wi.getProjectId()/$wi.getId()"))
                        #set($wisString = $wisString.concat(";"))
                #end
        
                <button class='polarion-rpw-table-cell-highlight $clickClass' customField="$customField" selectElement="true" onclick="createHTMLElement(this, '${wiTypeToBeCreated}', '${linkRole}', '${direction}', '${docPathForWi}', '${addAsChildNode}', '${buttonText}', '${wisString}', '${fieldValueList}')" title="$plusButtonTooltip"><img src="/polarion/ria/images/control/tablePlus.png" style="pd4ml-display:none;"></button>
     #end
  #end
#end

##Macro for creation of new workitem button with custom field
#macro(newWorkItemButton1 $wiTypeToBeCreated $direction $wiSubType $linkRole $docPathForWi $addAsChildNode $buttonText $plusButtonTooltip $workItemsToLink $fieldValueList)
  #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
     #if($trkrProject.can().createWorkItemOfType($wiTypeToBeCreated))
                #set($wisString = "")
                #set($customField = "")
                #set($lr= "")
                #foreach($wi in $workItemsToLink)
                        #set($lr= $wi.getRevision())
                        #set($wisString = $wisString.concat("$wi.getProjectId()/$wi.getId()"))
                        #set($wisString = $wisString.concat(";"))
                        
                #end
                #if($lr == "")
                        <button class='polarion-rpw-table-cell-highlight $clickClass' customField="$customField" selectElement="true" onclick="createHTMLElement1(this,'${wiTypeToBeCreated}', '${wiSubType}', '${linkRole}', '${direction}', '${docPathForWi}', '${addAsChildNode}', '${buttonText}', '${wisString}', '${fieldValueList}')" title="$plusButtonTooltip"><img src="/polarion/ria/images/control/tablePlus.png" style="pd4ml-display:none;"></button>
                #else
                        <button class='polarion-rpw-table-cell-highlight $clickClass' id="button$lr" customField="$customField" selectElement="true"  onclick="createHTMLElement1(this,'${wiTypeToBeCreated}', '${wiSubType}', '${linkRole}', '${direction}', '${docPathForWi}', '${addAsChildNode}', '${buttonText}', '${wisString}', '${fieldValueList}')" title="$plusButtonTooltip"><img src="/polarion/ria/images/control/tablePlus.png" style="pd4ml-display:none;"></button>
                #end
         #end
  #end
#end

##Macro for create ,link and edit button for workitem without custom field
#macro(renderLinkAndWiCreateEditButtons $wI $wiAttr $wiTypeToBeCreated $direction $linkRole $docPathForWi  $addAsChildNode $buttonText $plusButtonTooltip $workItemsToLink $fieldValueList)
 #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
    <table align="center" style="float:center;width:fit-content;height:5px;;pd4ml-display:none;vertical-align:bottom;" border="0"><tbody><tr> #if($wI.can().modify()) <td style="horizontal-align:center;vertical-align:bottom;height:5px;">#newWorkItemButton($wiTypeToBeCreated $direction $linkRole $docPathForWi  $addAsChildNode $buttonText $plusButtonTooltip $workItemsToLink $fieldValueList) </td><td style="horizontal-align:center;vertical-align:bottom;height:5px;">#newLinkingButton($wI)</td><td style="horizontal-align:center;vertical-align:bottom;height:5px;"><button class="polarion-rpw-table-cell-highlight $clickClass" $pathAttr="$wI.getProjectId()/$wI.getId()" $wiFieldsKey="$wiAttr" title="Click to Edit"> <img src="/polarion/ria/images/actions/edit.gif" style="pd4ml-display:none;"> </button></td> #end </tr></tbody></table>
  #end
#end

##Macro for create ,link and edit button for workitem with custom field
#macro(renderLinkAndWiCreateEditButtons1 $wI $wiAttr $wiTypeToBeCreated $direction $wiSubType $linkRole $docPathForWi  $addAsChildNode $buttonText $plusButtonTooltip $workItemsToLink $fieldValueList)
 #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
    <table align="center" style="float:center;width:fit-content;height:5px;;pd4ml-display:none;vertical-align:bottom;" border="0"><tbody><tr> #if($wI.can().modify()) <td style="horizontal-align:center;vertical-align:bottom;height:5px;">#newWorkItemButton1($wiTypeToBeCreated $direction $wiSubType $linkRole $docPathForWi  $addAsChildNode $buttonText $plusButtonTooltip $workItemsToLink $fieldValueList) </td><td style="horizontal-align:center;vertical-align:bottom;height:5px;">#newLinkingButton($wI)</td><td style="horizontal-align:center;vertical-align:bottom;height:5px;"><button class="polarion-rpw-table-cell-highlight $clickClass" $pathAttr="$wI.getProjectId()/$wI.getId()" $wiFieldsKey="$wiAttr" title="Click to Edit"> <img src="/polarion/ria/images/actions/edit.gif" style="pd4ml-display:none;"> </button></td> #end </tr></tbody></table>
  #end
#end

##Macro for link and edit button for workitem 
#macro(renderLinkAndWiEditButtons $wI $wiAttr)
 #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
    <table align="center" style="float:center;width:fit-content;height:5px;;pd4ml-display:none;vertical-align:bottom;" border="0"><tbody><tr> #if($wI.can().modify()) <td style="horizontal-align:center;vertical-align:bottom;height:5px;">#newLinkingButton($wI)</td><td style="horizontal-align:center;vertical-align:bottom;height:5px;"><button class="polarion-rpw-table-cell-highlight $clickClass" $pathAttr="$wI.getProjectId()/$wI.getId()" $wiFieldsKey="$wiAttr" title="Click to Edit"> <img src="/polarion/ria/images/actions/edit.gif" style="pd4ml-display:none;"> </button></td> #end </tr></tbody></table>
  #end
#end

##Macro for edit button for workitem 
#macro(renderWiEditButtons $wI $wiAttr)
 #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
    ##<table align="center" style="float:center;width:fit-content;height:5px;pd4ml-display:none;vertical-align:bottom;" border="0"><tbody><tr> #if($wI.can().modify()) <td  align="center" style="horizontal-align:center;vertical-align:bottom;height:5px;"><button class="polarion-rpw-table-cell-highlight $clickClass" $pathAttr="$wI.getProjectId()/$wI.getId()" $wiFieldsKey="$wiAttr" title="Click to Edit"> <img src="/polarion/ria/images/actions/edit.gif" style="pd4ml-display:none;"> </button></td> #end </tr></tbody></table>
        <table align="center" style="float:center;width:fit-content;height:5px;pd4ml-display:none;vertical-align:bottom;" border="0"><tbody><tr> <td  align="center" style="horizontal-align:center;vertical-align:bottom;height:5px;"><button class="polarion-rpw-table-cell-highlight $clickClass" $pathAttr="$wI.getProjectId()/$wI.getId()" $wiFieldsKey="$wiAttr" title="Click to Edit"> <img src="/polarion/ria/images/actions/edit.gif" style="pd4ml-display:none;"> </button></td> </tr></tbody></table>
  #end
  #if(!$lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
    ##<table align="center" style="float:center;width:fit-content;height:5px;pd4ml-display:none;vertical-align:bottom;" border="0"><tbody><tr> #if($wI.can().modify()) <td  align="center" style="horizontal-align:center;vertical-align:bottom;height:5px;"><button class="polarion-rpw-table-cell-highlight $clickClass" $pathAttr="$wI.getProjectId()/$wI.getId()" $wiFieldsKey="$wiAttr" title="Click to Edit"> <img src="/polarion/ria/images/actions/edit.gif" style="pd4ml-display:none;"> </button></td> #end </tr></tbody></table>
        <table align="center" style="float:center;width:fit-content;height:5px;pd4ml-display:none;vertical-align:bottom;" border="0"><tbody><tr> <td  align="center" style="horizontal-align:center;vertical-align:bottom;height:5px;"><button class="polarion-rpw-table-cell-highlight $clickClass" $pathAttr="$wI.getProjectId()/$wI.getId()" $wiFieldsKey="$wiAttr" title="Click to Edit"> <img src="/polarion/ria/images/actions/edit.gif" style="pd4ml-display:none;"> </button></td> </tr></tbody></table>
  #end
#end


##Macro to get linked items
#macro ( GetLinkedItems $lastRevisionNumber $workItem $type $linkRole $direction $returnAll $addOnQuery $linkedItem )
    #set($linkedItems = [] )
    #set($projectId = $workItem.getProjectId() )
        #set($wiId = $workItem.getId())
    #set($workItemId = "$projectId/$wiId")
    #set($query = "" )

    #if(!$linkRole.equals(""))
        #set($query = "type:${type} AND ${direction}:${linkRole}=${workItemId} ${addOnQuery}")
    #else
        #set($query = "type:${type} AND ${direction}:${workItemId} ${addOnQuery}")
    #end

    #if(!$lastRevisionNumber.equals(""))
        #set($baselineString = "${lastRevisionNumber}")
        #set($linkedItems = $trackerService.queryWorkItemsInBaseline($query, "id", $baselineString))
    #else
        #set($linkedItems = $trackerService.queryWorkItems($query, "id"))
    #end

    #if($linkedItems.size() > 0)
        #if( $returnAll )
                    #set($linkedItem = [] )
                        #foreach($lItem in $linkedItems)
                            #if(!$lItem.isUnresolvable())
                                #set($void = $linkedItem.add($lItem))
                                #end
                        #end
        #else
                    #set($lItem = $linkedItems.get(0))
                    #if(!$lItem.isUnresolvable())
                #set($linkedItem = $lItem)
                        #end
        #end
    #end
#end

##Macro to get design requirement workitems of subtype (electrical labeling mechanical) from project
#macro(getWorkItemsFromAllDocuments $docType $wiType $wItems)
    #set ($my_query = "type:function AND subType.KEY:(design) AND project.id:$page.getReference().projectId()") 
    #set($wItems = [])
    #if(!$!my_query.equals(""))
        #set($wItems = $trackerService.queryWorkItems($my_query, "id"))
    #else
        #set($wItems = $trackerService.queryWorkItems("type:function AND subType.KEY:(design) AND project.id:$projectID", "id"))
    #end
#end

##Macro to get design requirement workitems of subtype (electrical labeling mechanical) from selected document
#macro(getAllWorkitemsFromDocument $lastRevisionNumber $docPath $wiType $allWItems $selectedDocument $wItems)
        #set($allWItems = [])
        #set($wItems = [])
        #if($docPath != "")
                #set($docsLocation = $project.location.getLocation($docPath))
                #if(!$lastRevisionNumber == "")
                        #set($docsLocation = $docsLocation.setRevision($lastRevisionNumber))
                #end
                #set($modLocation = $project.getLocation().append($docPath))
                #if($trackerService.getModuleManager().existModule($project, $docsLocation ))
                    #set($itemsInDoc = [] )
                        #set($modManager = $trackerService.getModuleManager())
                        #set($relModLoc = $modLocation.getRelativeLocation($project.getLocation()))
                        #set($selectedDocument = $modManager.getModule($project, $relModLoc))
                        #if($selectedDocument && !$selectedDocument.isUnresolvable())
                                #if(!$lastRevisionNumber.equals(""))
                                        #set($baselineString = "${lastRevisionNumber}")
                                        #set($selectedDocument = $transaction.documents.getBy().revision($baselineString).oldApiObject($selectedDocument).getOldApi())
                                        #set($itemsInDoc = $trackerService.queryWorkItemsInBaseline($selectedDocument.createWorkItemsQuery().finish(), "id", $baselineString))
                                #else
                                        #set($itemsInDoc = $selectedDocument.getAllWorkItems())
                                #end
                        #end
                        #foreach($item in  $itemsInDoc )
                                #if(!$item.isUnresolvable())
                                        #set($void = $allWItems.add($item))
                                        #if($item.getType().getId().equals($wiType))
                                        #set($ST="")
                                        #set($ST= $item.getCustomField("subType").getId())
                                                #if($ST=="design" )
                                                        #set($void = $wItems.add($item))
                                                #end
                                        #end
                                #end
                        #end
                #else
                        #info("No valid document exists in the path '$docPath'. Please check your selection")
                #end
        #end
#end

##Macro for workitem sidebar
#macro( initializeWorkItemsSideBar )

 ## Sidebar Preparation START
        #set($builderWithSidebar = $transaction.context().createHtmlFragmentBuilderFor().rpeView())
        #set($displayedFieldsMap = $objectFactory.newMap())
        ## Sidebar: Displayed fields configuration for each group (main, linked, linkedToLinked) taken from Widget Parameters
        ## hazardousSituation Attr
        #set($hsAttrSidebarConfig = [])
        #set($void = $hsAttrSidebarConfig.add("description"))
        #set($void = $hsAttrSidebarConfig.add("subType"))
        #set($void = $hsAttrSidebarConfig.add("rationale"))
        #set($void = $hsAttrSidebarConfig.add("linkedWorkItems"))
        
                                        
        ## Failure Mode Attr
        #set($fmAttrSidebarConfig = [])
        #set($void = $fmAttrSidebarConfig.add("description"))
        #set($void = $fmAttrSidebarConfig.add("effectOfFailure"))
      
        #set($void = $fmAttrSidebarConfig.add("linkedWorkItems"))
        
        
        ## harm Attr
        #set($hmAttrSidebarConfig = [])
        #set($void = $hmAttrSidebarConfig.add("harmSeverity"))
        #set($void = $hmAttrSidebarConfig.add("linkedWorkItems"))

        ## RR Attr
        #set($rrAttrSidebarConfig = [])
        #set($void = $rrAttrSidebarConfig.add("p2Factor"))
        #set($void = $rrAttrSidebarConfig.add("riskAcceptability"))
        #set($void = $rrAttrSidebarConfig.add("mitigationEffective"))
        #set($void = $rrAttrSidebarConfig.add("rationale"))
        #set($void = $rrAttrSidebarConfig.add("linkedWorkItems"))
        
        ## Cause of Failure Attr
        #set($cfAttrSidebarConfig = [])
        #set($void = $cfAttrSidebarConfig.add("description"))
        #set($void = $cfAttrSidebarConfig.add("preOccurrence"))
        #set($void = $cfAttrSidebarConfig.add("postOccurrence"))
        #set($void = $cfAttrSidebarConfig.add("linkedWorkItems"))

        ## System Requirement Attr
        #set($srAttrSidebarConfig = [])
        #set($void = $srAttrSidebarConfig.add("rationale"))
        #set($void = $srAttrSidebarConfig.add("linkedWorkItems"))
        #set($void = $srAttrSidebarConfig.add("status"))
        #set($void = $srAttrSidebarConfig.add("severity"))

        ## RC Attr
        #set($rcAttrSidebarConfig = [])
        #set($void = $rcAttrSidebarConfig.add("description"))
        #set($void = $rcAttrSidebarConfig.add("preOccurrence"))
        #set($void = $rcAttrSidebarConfig.add("postOccurrence"))
        #set($void = $rcAttrSidebarConfig.add("linkedWorkItems"))
        ## DR Attr
        #set($drAttrSidebarConfig = [])
        #set($void = $drAttrSidebarConfig.add("subType"))
        #set($void = $drAttrSidebarConfig.add("description"))
        #set($void = $drAttrSidebarConfig.add("rationale"))
        #set($void = $drAttrSidebarConfig.add("linkedWorkItems"))
        #set($void = $drAttrSidebarConfig.add("criticalToQuality"))

        ## DS Attr
        #set($dsAttrSidebarConfig = [])
        #set($void = $dsAttrSidebarConfig.add("description"))
        #set($void = $dsAttrSidebarConfig.add("subType"))
        #set($void = $dsAttrSidebarConfig.add("preDetection"))
        #set($void = $dsAttrSidebarConfig.add("postDetection"))
        #set($void = $dsAttrSidebarConfig.add("typeOfControl"))
        #set($void = $dsAttrSidebarConfig.add("evidenceCurrentControls"))
        #set($void = $dsAttrSidebarConfig.add("verificationCurrentControls"))
        #set($void = $dsAttrSidebarConfig.add("recommendedActions"))
        #set($void = $dsAttrSidebarConfig.add("actionsTaken"))
        #set($void = $dsAttrSidebarConfig.add("rationale"))
        #set($void = $dsAttrSidebarConfig.add("linkedWorkItems"))
        


        
        ## userNeed Attr
        #set($unAttrSidebarConfig = [])
        #set($void = $unAttrSidebarConfig.add("status"))
        #set($void = $unAttrSidebarConfig.add("severity"))
        #set($void = $unAttrSidebarConfig.add("linkedWorkItems"))

        ## Function Attr
        #set($fAttrSidebarConfig = [])
        #set($void = $fAttrSidebarConfig.add("subType"))
        
        #set($void = $fAttrSidebarConfig.add("linkedWorkItems"))

        ## DEFAULT Attr
        #set($defaultAttrSidebarConfig = [])
        #set($void = $defaultAttrSidebarConfig.add("linkedWorkItems"))

        ## Sidebar: Add each group to the Displayed Fields Map - #set($void = $displayedFieldsMap.put("groupid", $displayedFieldsGroupID))
        #set($void = $displayedFieldsMap.put("hsAttr", $hsAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("hmAttr", $hmAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("rrAttr", $rrAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("rcAttr", $rcAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("drAttr", $drAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("dsAttr", $dsAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("unAttr", $unAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("fmAttr", $fmAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("cfAttr", $cfAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("srAttr", $srAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("fAttr", $fAttrSidebarConfig))
        #set($void = $displayedFieldsMap.put("defaultAttr", $defaultAttrSidebarConfig))
        ## Sidebar: Choose unique ID - #set($myContainerId = "myUniqueId")
        #set($myContainerId = "traceabilityTableWithSidebar_$widgetContext.generateUniqueElementId()")
        #set($sidebarConfiguration = $renderingContext.propertiesSidebarConfiguration().containerId("$myContainerId").fieldsConfiguration($displayedFieldsMap).addTo($builderWithSidebar))
        #set($pathAttr = $sidebarConfiguration.attributes().referencePath())
        #set($clickClass = $sidebarConfiguration.attributes().clickableCssClass())
        #set($wiFieldsKey = $sidebarConfiguration.attributes().fieldsConfigurationKey())
        ## Sidebar Configuration END
#end

##Macro to display document data after selection of document 
#macro(displayDocumentData $sDocument)
<left>
#if($allFMEAItems.equals("no"))
        #if($sDocument && !$sDocument.isUnresolvable())
                #set($docRenderer = $transaction.documents().getBy().oldApiObject($sDocument))
                #set($bName ="")
                        #if($sDocument)
                                #baselineTable ($sDocument)
                        #end
                        #set($blRev = "")
                        #set($RevisionNumber = "")
                        #set($blRev = $!urlParameters.baselinerevid.trim())
                        #if(!$blRev.equals(""))
                                #set($RevisionNumber = $blRev)
                        #else
                                #set($RevisionNumber = "")
                        #end
                
                        #set($blines = $trackerService.getDataService().sqlSearch("SELECT * FROM baseline INNER JOIN project ON baseline.fk_uri_project = project.c_uri INNER JOIN module ON baseline.fk_uri_baseobject = module.c_uri WHERE project.c_id='$proj_id' AND module.c_modulefolder='$sDocument.getModuleFolder()' AND module.c_id='$sDocument.getModuleName()' ORDER BY baseline.c_baserevision DESC"))
                        #foreach($bline in $blines)        
                                #set($bRevision =""        )                                        
                                #set($bRevision = $bline.getBaseRevision())
                                #set($void = $blMap.put($bRevision, $bline.getName()))        
                                #foreach ($mapEntry in $blMap.entrySet())
                                #set($bName =$!{blMap.get($RevisionNumber)})
                                #end
                        #end
                        #if($RevisionNumber == "")
                                #set($bName = "Current Version") 
                        #end
                        
                        Project: <span style="font-weight: bold;font-style: italic;">$project.getName()</span> <br>
                        Document Title: <span style="font-weight: bold;font-style: italic;">$docRenderer.render().withLinks().htmlFor().forFrame()</span> <br>
                        Document Revision:  <span style="font-weight: bold;font-style: italic;">$bName</span> <br>

                        ## Selected Document Custom Fields could be displayed here.  For example
                        ## Scope: <span style="font-weight: bold;font-style: italic;">$!docRenderer.fields().get("scope").render().htmlFor().forFrame()</span> <br>
                        
        #else
                        Title: <span style="font-weight: bold;font-style: italic;">$project.getName() - FMEA</span> <br>
                        Project: <span style="font-weight: bold;font-style: italic;">$project.getName()</span> <br>
        #end
#else
                #baselineTableAllFmea ()
                
                #set($blRev = "")
                        #set($RevisionNumber = "")
                        #set($blRev = $!urlParameters.baselinerevid.trim())
                        #if(!$blRev.equals(""))
                                #set($RevisionNumber = $blRev)
                        #else
                                #set($RevisionNumber = "")
                        #end
                #set($blines = $trackerService.getTrackerProject("$projectID").getBaselinesManager().getBaselines())
                        #foreach($bline in $blines)        
                                #set($bRevision =""        )                                        
                                #set($bRevision = $bline.getBaseRevision())
                                #set($void = $blMap.put($bRevision, $bline.getName()))        
                                #foreach ($mapEntry in $blMap.entrySet())
                                #set($bName =$!{blMap.get($RevisionNumber)})
                                #end
                        #end
                        #if($RevisionNumber == "")
                                #set($bName = "Current Version") 
                        #end

                Project: <span style="font-weight: bold;font-style: italic;">$project.getName()</span> <br>        
                Project Revision: <span style="font-weight: bold;font-style: italic;">$bName</span> <br>        
#end
</left>
<br>
#end

##Macro to display project baselines information in tabular format.
#macro(baselineTableAllFmea )
<div style="padding: 0px 0px 0px 20px;">
<div class="polarion-rp-column"  >
</div>
                
                ##set($prjBaselines = $trackerService.getDataService().sqlSearch("SELECT * FROM baseline INNER JOIN project ON baseline.fk_uri_project = project.c_uri WHERE project.c_id='$projectID' ORDER BY baseline.c_baserevision DESC"))
                ##set($prjBaselines = $trackerService.getDataService().sqlSearch("SELECT bc.c_uri FROM polarion.baselinecollection bc INNER JOIN polarion.project pj ON pj.c_uri=bc.fk_uri_project AND pj.c_id='$projectID' ORDER BY bc.c_name"))
                #set($prjBaselines = $trackerService.getTrackerProject("$projectID").getBaselinesManager().getBaselines())
                
                #set($dataService = $trackerService.getDataService())
                #set($headerRendered = false)
                #set($counter = 0)
                <center><div style="pd4ml-display: none ; "><button  class = "button1"onclick="generateReport()" class="reportbutton" VALIGN=MIDDLE>View Current Version</button></div></center><br>
                <table class="polarion-Document-table"  style=" float: right; margin-left:auto; margin-right: 0px; empty-cells: show; border-collapse: collapse; border: 1px solid #CCCCCC; padding: 5px; width: 55%;">
                        <tbody>
                                #foreach($prjBaseline in $prjBaselines)        
                                        #set($prjBaseDescription ="")                
                                        #set($prjBaseRevision =""        )
                                        #set($prjCurrRevisionDate= "")
                                        #set($prjBaseDescription = $prjBaseline.getDescription())
                    #set($prjBaseRevision = $prjBaseline.getBaseRevision())
                                        #set($prjBName = $prjBaseline.getName()) 
                                        #if($prjBaseDescription== "" )
                                                #set($prjBaseDescription= "")
                                        #else
                                                #set($prjBaseDescription= $prjBaseDescription)
                                        #end
                                        
                                                #if($headerRendered == false)
                                                        <tr>
                                                                
                                                                <th style="border: 1px solid #CCCCCC; padding: 5px;">Baseline Name</th>
                                                                <th style="border: 1px solid #CCCCCC; padding: 5px;">Baseline Description</th>
                                                                <th style="border: 1px solid #CCCCCC; padding: 5px;">Date/Time</th>
                                                                                                                           
                                                        </tr>
                                                        #set($headerRendered = true)
                                                #end
                                                 #set($counter = $counter + 1)                
                                                ##set($prjBaseLink = $transaction.context().createPortalLink().project("$proj_id").revision("$prjBaseRevision").toEncodedRelativeUrl())
                                                #set($prjBaseLink = $transaction.context().createPortalLink().baseline("$prjBaseRevision").project("$projectID").toEncodedRelativeUrl())
                                                #set($prjRevision = $dataService.getRevision("default", $prjBaseRevision))
                                                #set($prjRevisionDate = "-")
                                                #if(!$prjRevision.isUnresolvable())
                                                        #set($prjRevisionDate = $prjRevision.getCreated().toLocaleString())
                                                #end
                                                <tr>
                                                        <td style="border: 1px solid #CCCCCC; padding: 5px;">
                                                        
                                                                <input type="radio" id='regular$prjBaseRevision' name="optradio"  onclick="generateReport1($prjBaseRevision)"><a href="$prjBaseLink" target="_blank">$prjBaseline.getName()</a>
                                                        
                                                        </td>
                                                        <td style="border: 1px solid #CCCCCC; padding: 5px;">$prjBaseDescription</td>
                                                        <td style="border: 1px solid #CCCCCC; padding: 5px;">$!prjRevisionDate</td>
                                                </tr>
                                #end

                        </tbody>
                </table>
        </div>
#end

##Macro to display selected document's baselines information in tabular format.
#macro(baselineTable $sDocument)

#set($proj_id = $sDocument.getProjectId())
<div style="padding: 0px 0px 0px 20px;">

<div class="polarion-rp-column"  >
</div>
                #set($baselines = $trackerService.getDataService().sqlSearch("SELECT * FROM baseline INNER JOIN project ON baseline.fk_uri_project = project.c_uri INNER JOIN module ON baseline.fk_uri_baseobject = module.c_uri WHERE project.c_id='$proj_id' AND module.c_modulefolder='$sDocument.getModuleFolder()' AND module.c_id='$sDocument.getModuleName()' ORDER BY baseline.c_baserevision DESC"))
                #set($dataService = $trackerService.getDataService())
                #set($headerRendered = false)
                #set($counter = 0)
                <center><div style="pd4ml-display: none ; "><button  class = "button1"onclick="generateReport()" class="reportbutton" VALIGN=MIDDLE>View Current Version</button></div></center><br>
                <table class="polarion-Document-table"  style=" float: right; margin-left:auto; margin-right: 0px; empty-cells: show; border-collapse: collapse; border: 1px solid #CCCCCC; padding: 5px; width: 55%;">
                        <tbody>
                                #foreach($baseline in $baselines)        
                                        #set($baseDescription ="")                
                                        #set($baseRevision =""        )
                                        #set($currRevisionDate= "")
                                        #set($baseDescription = $baseline.getDescription())
                    #set($baseRevision = $baseline.getBaseRevision())
                                        #set($bName = $baseline.getName()) 
                                        #if($baseDescription== "" )
                                                #set($baseDescription= "")
                                        #else
                                                #set($baseDescription= $baseDescription)
                                        #end
                                        
                                                #if($headerRendered == false)
                                                        <tr>
                                                                
                                                                <th style="border: 1px solid #CCCCCC; padding: 5px;">Baseline Name</th>
                                                                <th style="border: 1px solid #CCCCCC; padding: 5px;">Baseline Description</th>
                                                                <th style="border: 1px solid #CCCCCC; padding: 5px;">Date/Time</th>
                                                                                                                           
                                                        </tr>
                                                        #set($headerRendered = true)
                                                #end
                                                 #set($counter = $counter + 1)                
                                                #set($baseLink = $transaction.context().createPortalLink().project("$proj_id").document("$sDocument.getModuleFolder()" , "$sDocument.getModuleName()").revision("$baseRevision").toEncodedRelativeUrl())
                                                #set($revision = $dataService.getRevision("default", $baseRevision))
                                                #set($revisionDate = "-")
                                                #if(!$revision.isUnresolvable())
                                                        #set($revisionDate = $revision.getCreated().toLocaleString())
                                                #end
                                                <tr>
                                                        <td style="border: 1px solid #CCCCCC; padding: 5px;">
                                                        
                                                                <input type="radio" id='regular$baseRevision' name="optradio"  onclick="generateReport1($baseRevision)"><a href="$baseLink" target="_blank">$baseline.getName()</a>
                                                        
                                                        </td>
                                                        <td style="border: 1px solid #CCCCCC; padding: 5px;">$baseDescription</td>
                                                        <td style="border: 1px solid #CCCCCC; padding: 5px;">$!revisionDate</td>
                                                </tr>
                                #end

                        </tbody>
                </table>
        </div>
#end

##Macro to display table headers
#macro(displayTableAndHeader $selDocument)
  ##Export excel button widget servlet parameters
  <div class="polarion-rp-widget-part" data-widget="ExportExcelButton">   
  ##<input type="text" id="myInput"  placeholder="Keyword Search" title="Keyword Search"> <br>

          <span class="polarion-rp-widget-parameters">
                <sub id="tableid">ufmea</sub>
                <sub id="tableclass">polarion-rpw-table-content</sub>
                <sub id="rowstartpos">0</sub>
                <sub id="colstartpos">0</sub>
        <sub id="mergedcells">true</sub>
                <sub id="filename">Design FMEA Report</sub>
          </span>
         
  </div>
<table class="polarion-rpw-table-main" id="$myContainerId">
        <tbody>
                <tr>
                        <td> <div>
 <table class="polarion-rpw-table-content" border="2px" id="ufmea">
   <thead>
    <tr>
        #if ($colorScheme.equals("AltColors") ) ## {
            ##Table headers
            <th style="background-color: #e60000;"><font color="#FFFFFF">DESIGN FUNCTION</font></th>
            <th style="background-color: #e60000;"><font color="#FFFFFF">DESIGN REQUIREMENTS</font></th>
            <th style="background-color: #e60000;"><font color="#FFFFFF">CTQ</font></th>      
            <th style="background-color: #e60000;"><font color="#FFFFFF">FAILURE MODE</font></th>
            <th style="background-color: #e60000;"><font color="#FFFFFF">HAZARDOUS SITUATION</font></th>
            <th style="background-color: #00BEDC;"><font color="#FFFFFF">SEV</font></th>
            <th style="background-color: #FF9000;"><font color="#FFFFFF">EFFECT OF FAILURE</font></th>
            <th style="background-color: #FF9000;"><font color="#FFFFFF">ROOT CAUSE</font></th>
            <th style="background-color: #00BEDC;"><font color="#FFFFFF">PRE OCCURANCE</font></th>
            <th style="background-color: #00AF8E;"><font color="#FFFFFF">POST OCCURRENCE</font></th>           
            <th style="background-color: #FF9000;"><font color="#FFFFFF">CURRENT DESIGN CONTROLS</font></th>
            <th style="background-color: #FF9000;"><font color="#FFFFFF">TYPE OF CONTROL</font></th>
            <th style="background-color: #FF9000;"><font color="#FFFFFF">EVIDENCE OF IMPLEMENTATION OF CONTROLS</font></th>
            <th style="background-color: #FF9000;"><font color="#FFFFFF">EVIDENCE OF VERIFICATION OF EFFECTIVENESS OF CONTROLS</font></th>
            <th style="background-color: #00BEDC;"><font color="#FFFFFF">PRE DETECTION</font></th>
            <th style="background-color: #00BEDC;"><font color="#FFFFFF">PRE RPN</font></th>
            <th style="background-color: #00BEDC;"><font color="#FFFFFF">PRE RISK REDUCED AFAP</font></th>
            <th style="background-color: #e60000;"><font color="#FFFFFF">RECOMMENDED ACTIONS</font></th>
            <th style="background-color: #e60000;"><font color="#FFFFFF">ACTION TAKEN, EVIDENCE OF IMPLEMENTATION AND VERIFICATION OF EFFECTIVENESS OF CONTROLS</font></th>
            <th style="background-color: #00AF8E;"><font color="#FFFFFF">POST DETECTION</font></th>
            <th style="background-color: #00AF8E;"><font color="#FFFFFF">POST RPN </font></th>
            <th style="background-color: #00AF8E;"><font color="#FFFFFF">POST RISK REDUCED AFAP</font></th>
            <th style="background-color: #00AF8E;"><font color="#FFFFFF">RISK BENEFIT ANALYSIS </font></th>
        #else
            ##Table headers
            <th style="background-color: #00557C;"><font color="#FFFFFF">DESIGN FUNCTION</font></th>
            <th style="background-color: #00557C;"><font color="#FFFFFF">DESIGN REQUIREMENTS</font></th>
            <th style="background-color: #00557C;"><font color="#FFFFFF">CTQ</font></th>  
            <th style="background-color: #00557C;"><font color="#FFFFFF">FAILURE MODE</font></th>
             <th style="background-color: #00557C;"><font color="#FFFFFF">HAZARDOUS SITUATION</font></th>
            <th style="background-color: #0087BE;"><font color="#FFFFFF">SEV</font></th>
            <th style="background-color: #00646E;"><font color="#FFFFFF">EFFECT OF FAILURE</font></th>
            <th style="background-color: #00646E;"><font color="#FFFFFF">ROOT CAUSE</font></th>
            <th style="background-color: #0087BE;"><font color="#FFFFFF">PRE OCCURANCE</font></th>
            <th style="background-color: #00AF8E;"><font color="#FFFFFF">POST OCCURRENCE</font></th>   
            <th style="background-color: #00646E;"><font color="#FFFFFF">CURRENT DESIGN CONTROLS</font></th>
            <th style="background-color: #00646E;"><font color="#FFFFFF">TYPE OF CONTROL</font></th>
            
            <th style="background-color: #00646E;"><font color="#FFFFFF">EVIDENCE OF IMPLEMENTATION OF CONTROLS</font></th>
            <th style="background-color: #00646E;"><font color="#FFFFFF">EVIDENCE OF VERIFICATION OF EFFECTIVENESS OF CONTROLS</font></th>
            <th style="background-color: #00BEDC;"><font color="#FFFFFF">PRE DETECTION</font></th>
            <th style="background-color: #00BEDC;"><font color="#FFFFFF">PRE RPN</font></th>
            <th style="background-color: #00BEDC;"><font color="#FFFFFF">PRE RISK REDUCED AFAP</font></th>
             <th style="background-color: #00557C;"><font color="#FFFFFF">RECOMMENDED ACTIONS</font></th>
            <th style="background-color: #00557C;"><font color="#FFFFFF">ACTION TAKEN, EVIDENCE OF IMPLEMENTATION AND VERIFICATION OF EFFECTIVENESS OF CONTROLS </font></th>          
            <th style="background-color: #00AF8E;"><font color="#FFFFFF">POST DETECTION</font></th>
            <th style="background-color: #00AF8E;"><font color="#FFFFFF">POST RPN </font></th>
             <th style="background-color: #00AF8E;"><font color="#FFFFFF">POST RISK REDUCED AFAP</font></th>
            <th style="background-color: #00AF8E;"><font color="#FFFFFF">RISK BENEFIT ANALYSIS </font></th>
        #end ## } end of #if ($colorScheme.equals("AltColors") )
    </tr>

   </thead>
   <tbody id="myTableBody">
#end

## Display data in table using revision and url parameters
#macro(fmeaTable $revision $urlInputs )

    #set($lastRevisionNumber = $revision )

        ## If $lastRevisionNumber exists then this is a locked down query to a revision
    #if(!$lastRevisionNumber.equals(""))
        #set( $baselineString = "${lastRevisionNumber}")
    #end

        ##Get url parameters
        #set($inputDocPath = $urlInputs.docName )
        #set($allFMEAItems = "")
        #set($newWorkItemId = $urlInputs.newWiId )
        #set($readOnlyReport = $urlInputs.readOnly )
        #set($autoReloadReport = $urlInputs.autoReload )

    #set($fmeItems = [])
        #set($docItems = [])

        #set($enumpOc = $transaction.enumerations().getEnumeration("pOccurrence").forType("").forProject($page.getReference().projectId()))
        #set($pList = [] )
        #set($pList1 = [] )

        #foreach ($optionp in $enumpOc.options)
                #set ($foo = $pList.add("$optionp.render()") )
        #end

        #foreach ($optionp in $enumpOc.options)
                #set ($foo = $pList1.add("$optionp.render().withIcon(false)") )
        #end

        ## setting all Fmea items to NO if document selected
        #if($inputDocPath.equals("allFmeaItems"))
            #set($allFMEAItems = "yes")
        #else
            #set($allFMEAItems = "no")
        #end

        ##Get design requirement work items from project or from selected document
    #if($allFMEAItems.equals("no"))
            #getAllWorkitemsFromDocument($lastRevisionNumber $inputDocPath "function" $docItems $selDocument $fmeItems)
    #else
        #getWorkItemsFromAllDocuments($docType "function" $fmeItems)
        #end
        
        ##Call to macros initializeWorkItemsSideBar() and renderLinkingDialog()
        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
           #initializeWorkItemsSideBar()
           #renderLinkingDialog()
        #elseif(!$lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                #initializeWorkItemsSideBar()
                   #renderLinkingDialog()
        #end
        
        ##Call to macro displayDocumentData($selDocument) to display data of selected document
    #displayDocumentData($selDocument)

        ##Call to macro displayTableAndHeader($selDocument) to display table headers of selected document
        #displayTableAndHeader($selDocument)

        ## Final Rowsapn calculation        
        #set($pFunRowSpan = 0)
                #foreach($fmeWi in $fmeItems)
                        ##
                        ##  Get Function
                        ##
                        #set($fmeRowSpan = 0)
                        #set($lstRev = "")
                        #set($lstRev = $fmeWi.getRevision())
                        #set($HSItems = [])
                        
                        #set($designRequirements = [])
                         
                        #GetLinkedItems ($lastRevisionNumber $fmeWi "designRequirement" $linkrole_Classifies "linkedWorkItems" true "AND NOT status:obsolete" $designRequirements )
                        #set($void = $fmeCfdMap.put($fmeWi.getId(), $designRequirements))
                        #if($designRequirements.size() == 0)
                                        #set($fmeRowSpan = $math.add($fmeRowSpan,1))
                                        #set($ueRowSpan = 1)
                        #else
                        #set($fmeRowSpan = $designRequirements.size())
                        #foreach($ueWi in $designRequirements)
                                #set($ueRowSpan = 0)
                                #set($causeFailures = [])
                                #GetLinkedItems($lastRevisionNumber $ueWi "causeOfFailure" $linkrole_Causes "linkedWorkItems" true "AND NOT status:obsolete" $causeFailures )
                                #set($void = $uecfMap.put($ueWi.getId(), $causeFailures))
                                                #if($causeFailures.size() > 0)
                                                        #set($ueRowSpan = $causeFailures.size())
                                                        #set($ueRowSpan = $math.sub($ueRowSpan,1))
                                                        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                                                ##set($ueRowSpan = $math.add($ueRowSpan,1))
                                                        #end
                                                #end
                                #set($fmeRowSpan = $math.add($fmeRowSpan, $ueRowSpan))
                                #set($void = $cfdFaSizeMap.put($ueWi.getId(), $ueRowSpan))
                                
                                #foreach($causeFailure in $causeFailures)
                                        #set($cfRowSpan = 0)
                                        #set($systemRequirements = [])
                                        #GetLinkedItems($lastRevisionNumber $causeFailure "designSpecification" $linkrole_Controls "linkedWorkItems" true "AND NOT status:obsolete" $systemRequirements )
                                        #set($void = $cfsrMap.put($causeFailure.getId(), $systemRequirements))
                                                #if($systemRequirements.size() > 0)
                                                        #set($cfRowSpan = $systemRequirements.size())
                                                        #set($cfRowSpan = $math.sub($cfRowSpan,1))
                                                        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                                                ##set($ueRowSpan = $math.add($ueRowSpan,1))
                                                        #end
                                                #end
                                        #set($fmeRowSpan = $math.add($fmeRowSpan, $cfRowSpan))
                                #end
                        #end
                #end        
                                
                #set($void = $fmeRowSpanMap.put($fmeWi.getId(), $fmeRowSpan))
                #set($pFunRowSpan = $math.add($pFunRowSpan,$fmeRowSpan))
                                
                #end
                #if($allFMEAItems.equals("no") && $lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                        #set($pFunRowSpan = $math.add($pFunRowSpan,1))
                #end
                ## call to printFmeRows macro to display data in table
                

                #if($fmeItems.size() == 0)
                        #if(!$!selDocument.equals("") && $allFMEAItems.equals("no"))
                                #if(!$!selDocument.isUnresolvable())
                                        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                                #set($fmDocument = "$!selDocument.getFolder().getName()/$!selDocument.getModuleName()")
                                                <tr>
                                                        
                                                                #printFMEColumns($lastRevisionNumber "" "" $fmDocument)
                                                </tr>
                                        #end
                                #end
                        #else
                                #info("No data available to display report table content")
                        #end
                #else
                    #printFmeRows($lastRevisionNumber $inputDocPath $fmeItems $pFunRowSpan)   
                #end

          </tbody>
        </table>
        </div>
    ## Sidebar: Render helper HTML fragment
    $!builderWithSidebar
        </td>
                </tr>
        </tbody>
</table>  

##Call to initScriptToUpdateInputs() macro to update urlParameters as per input parameter selection
        #initScriptToUpdateInputs()
#end

##Macro to display work item data Space/Document where workitem is present
#macro(wiData $FMWi)
        <div style="pd4ml-display: none;">
        <left>
                <button type="button" class="collapsible"></button>        
                <div class="colcontent1">
                <table>
                <tr><td>Space / Document:</td></tr>
                <tr><td>
                        #set($docData="")
                        #if(!$FMWi.equals(""))
                                #set($wiRend =$transaction.workItems().getBy().oldApiObject($FMWi))
                                #set($docData=$wiRend.fields().module().render().withIcon().withLinks().openLinksInNewWindow())
                        #end
                        $!docData
                </td></tr>
                </table>
                </div>
        </left>
        </div>
        <br>
#end


##macro to display data rowwise manner
#macro(printFmeRows $lastRevisionNumber $inputDocPath $fmeWItems $pFunRowSpan)
          #set($fmCount = 0)
    #foreach($FMWi in $fmeWItems)

                ##Get Module name
                #set($fmodule = $FMWi.getModule())
                #set($fmDocument = "")
                #if($inputDocPath.equals("allFmeaItems"))
                   #set($fmDocument = "")
                #else
                 #set($fmDocument = "$!fmodule.getFolder().getName()/$!fmodule.getModuleName()")     
                #end         
                ##display data of each design requirement
                <tr>
                        #if($fmCount == 0)
                                #printFMEColumns($lastRevisionNumber $FMWi $pFunRowSpan $fmDocument)
                        #else
                                #printFMEColumns($lastRevisionNumber $FMWi 0 $fmDocument)
                        #end
                        #set($fmCount =  $math.add($fmCount,1))
                </tr>
                ##Display data of refined requirements
                #set($hideRow = "")
            #set($hideRow = $!urlParameters.myRow.trim())
                #if($hideRow =="yes")
                        #set($DRs=[])
                        #GetLinkedItems($lastRevisionNumber $FMWi "designSpecification" $linkrole_Refines "linkedWorkItems" true "" $DRs )
                        
                        #set($UNSRRowSpan = 0)
                        #set($UNSRRowSpan=$DRs.size())
                        #if($DRs.size() > 0)
                        <tr class= "myRow">
                                #printUNColumns($lastRevisionNumber $FMWi $UNSRRowSpan)
                                #foreach($DR in $DRs)
                                        #if($velocityCount>1)
                                                <tr class= "myRow">
                                        #end
                                        #printUNSRColumns($lastRevisionNumber $FMWi $DR)
                                #end
                        </tr>
                        #end
                #end
    #end                
        #if($allFMEAItems.equals("no") && $lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                #*<tr>
                        #printFMEColumns($lastRevisionNumber "" "" $fmDocument)
                </tr> *#
        #end
#end

##Macro to print design requirement data for refined requirements with background gray
#macro(printUNColumns $lastRevisionNumber $FMWi $UNSRRowSpan)
        #if(!$FMWi.equals(""))
                        ## Function column
                        ##Column1 : DESIGN FUNCTION
                        <td rowspan="$UNSRRowSpan" class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; " bgcolor="ECECEC">
                        
                        </td>
                ##Column 2: DESIGN REQUIREMENT
            ##set($fmPath = "$FMWi.getReference().toPath()")
        <td rowspan="$UNSRRowSpan" class="polarion-rpw-table-content-row" bgcolor="ECECEC">
                   #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                <table height="100%" width="100%">
                                                <tr style="vertical-align:bottom;height:5px;">
                                                <td>
                                                        #RenderWorkItem($FMWi)<br>
                                                        #wiData($FMWi)                                                           
                                                </td>
                                                </tr>
                                                <tr style="vertical-align:bottom;height:5px;">
                                                <td style="vertical-align:bottom;text-align:center;">
                                                        #renderLinkAndWiEditButtons($FMWi "unAttr")
                                                </td>
                                                </tr>
                                </table>
                        #else
                                #RenderWorkItem($FMWi)<br>
                        #end
        </td>
                        
                <td rowspan="$UNSRRowSpan" style="text-align:center;" bgcolor="ECECEC" class="polarion-rpw-table-content-row">
                
                </td>
                <td rowspan="$UNSRRowSpan" bgcolor="ECECEC">
                </td>
                <td rowspan="$UNSRRowSpan"  bgcolor="ECECEC">
                </td>
                <td rowspan="$UNSRRowSpan" bgcolor="ECECEC">
                </td>
                <td rowspan="$UNSRRowSpan" bgcolor="ECECEC">
                </td>
                <td rowspan="$UNSRRowSpan" bgcolor="ECECEC">
                </td>
                <td rowspan="$UNSRRowSpan" bgcolor="ECECEC">
                </td>
                <td rowspan="$UNSRRowSpan" bgcolor="ECECEC">
                </td>
        #end
#end

##Macro to display refined design Specifications to design requirement
#macro(printUNSRColumns $lastRevisionNumber $FMWi $DR )
        #if(!$FMWi.equals(""))
                #if(!$DR.equals(""))
                #set($crToQual=false)
                #set($crToQual=$DR.getCustomField("criticalToQuality"))
                #if($crToQual)
                ##Column 11: DESIGN SPECIFICATION
                ##Color in the cell when criticalTO Quality is not populated.
                <td class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; " bgcolor="FFFF33">
                #else
                ##Color in the cell when criticalTO Quality is populated.
                <td class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; " bgcolor="ECECEC">
                #end
                        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                        #set($workItemsToLink = [])
                                        #set($countCF=0)
                                        <table height="100%" width="100%" style="border-collapse: collapse;">
                                                <tr >        
                                                <td >
                                                        <table height="100%" width="100%">
                                                        <tr style="vertical-align:bottom;height:5px;">
                                                        <td>
                                                                #RenderWorkItem($DR)
                                                                #set($void = $workItemsToLink.add($FMWi))        
                                                        </td>
                                                        </tr>
                                                                <tr style="vertical-align:bottom;height:5px;">
                                                                <td style="vertical-align:bottom;text-align:center;">
                                                                        #renderLinkAndWiEditButtons($DR "dsAttr")
                                                                        #set($countCF= $countCF +1)
                                                                </td>
                                                                </tr>
                                                        </table>
                                                </td>
                                                </tr>
                                        </table>
                        #else
                                #set($countCF=0)
                                <table height="100%" width="100%" style="border-collapse: collapse;">
                                        <tr >
                                                <td >
                                                        #RenderWorkItem($DR)<br>
                                                </td>
                                        </tr>
                                </table>
                        #end
                </td>

                ##Column 12: Mitigation Rationale
                <td  class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; " bgcolor="ECECEC">
                        #set($mitiRationale="")
                        #RenderWorkItemField($SR $rationale $mitiRationale)
                        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                <table height="100%" width="100%">
                                    <tr style="vertical-align:bottom;height:5px;">
                                    <td>
                                            $mitiRationale
                                    </td>
                                    </tr>
                                    <tr style="vertical-align:bottom;height:5px;">
                                    <td style="vertical-align:bottom;text-align:center;">
                                            #if(!$mitiRationale.equals(""))
                                                    #renderWiEditButtons($DR "dsAttr")
                                            #end
                                    </td>
                                    </tr>
                                </table>
                        #else
                                $mitiRationale
                        #end
                </td>
                #end
        #end
#end

##Macro to display design specifications linked to root cause
#macro(printSRColumns $lastRevisionNumber $FMWi $UEWi $CFWi $SRWi $documentForWi)
        #if($SRWi.equals("NA"))
            #set($workItemsToLink = [])
                #set($void = $workItemsToLink.add($CFWi))
       <td colspan="2" style="padding-left: 20px;">#newWorkItemButton("designSpecification" "backLinked" $linkrole_Controls $documentForWi "no" "Create Design Specification" "Click to Design Specification" $workItemsToLink "")</td>
        #elseif(!$SRWi.equals(""))
                #set($crToQual=false)
                #set($crToQual=$SRWi.getCustomField("criticalToQuality"))
                #if($crToQual)
                ##Column 11: DESIGN SPECIFICATION
                ##Color in the cell when criticalTO Quality is not populated.
                <td class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; " bgcolor="FFFF33">
                #else
                ##Color in the cell when criticalTO Quality is populated.
                <td class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; ">
                #end
                        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                        #set($workItemsToLink = [])
                                        #set($countCF=0)
                                        <table height="100%" width="100%" style="border-collapse: collapse;">
                                                <tr >        
                                                <td >
                                                        <table height="100%" width="100%">
                                                        <tr style="vertical-align:bottom;height:5px;">
                                                        <td>
                                                                #RenderWorkItem($SRWi)
                                                                #set($void = $workItemsToLink.add($CFWi))        
                                                        </td>
                                                        </tr>
                                                                <tr style="vertical-align:bottom;height:5px;">
                                                                <td style="vertical-align:bottom;text-align:center;">
                                                                        #renderLinkAndWiCreateEditButtons($SRWi "dsAttr" "designSpecification" "backLinked" $linkrole_Controls $documentForWi "no" "Create Design Specification" "Click to create Design Specification" $workItemsToLink "")
                                                                        #set($countCF= $countCF +1)
                                                                </td>
                                                                </tr>
                                                        </table>
                                                </td>
                                                </tr>
                                        </table>
                        #else
                                #set($countCF=0)
                                <table height="100%" width="100%" style="border-collapse: collapse;">
                                        <tr >
                                                <td >
                                                        #RenderWorkItem($SRWi)<br>
                                                </td>
                                        </tr>
                                </table>
                        #end
                </td>

                ##Column 12: Mitigation Rationale
                <td>
                        #set($mitiRationale="")
                                #RenderWorkItemField($SRWi $rationale $mitiRationale)
                                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                        <table height="100%" width="100%">
                                                        <tr style="vertical-align:bottom;height:5px;">
                                                        <td>
                                                                $mitiRationale
                                                        </td>
                                                        </tr>
                                                        <tr style="vertical-align:bottom;height:5px;">
                                                        <td style="vertical-align:bottom;text-align:center;">
                                                                #if(!$mitiRationale.equals(""))
                                                                        #renderWiEditButtons($SRWi "dsAttr")
                                                                #end
                                                        </td>
                                                        </tr>
                                        </table>
                                #else
                                        $mitiRationale
                                #end
                </td>
        #else
        ## Create new designespecification workitem if not present
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                        #set($workItemsToLink = [])
                        #set($void = $workItemsToLink.add($CFWi))
                        <td colspan="2" style="padding-left: 20px;">#newWorkItemButton("designSpecification" "backLinked" $linkrole_Controls  $documentForWi "no" "Create Design Specification" "Click to Design Specification" $workItemsToLink "")</td>
                #else
                        <td></td>
                        <td></td>
                #end
        #end
#end

##Macro to display root causes linked to failure mode workitem
#macro(printCFColumns $lastRevisionNumber $FMWi $UEWi $CFWi $documentForWi)
        #if($CFWi.equals("NA"))
                 #set($cfRowspan = 1)
            #set($workItemsToLink = [])
                #set($void = $workItemsToLink.add($UEWi))
       <td colspan="3" style="padding-left: 20px;">#newWorkItemButton("causeOfFailure" "backLinked" $linkrole_Causes  $documentForWi "no" "Create Root Cause" "Click to Root Cause" $workItemsToLink "")</td>
        #elseif(!$CFWi.equals(""))
                 #set($cfRowspan = $cfsrMap.get($CFWi.getId()).size())
                 #if($cfRowspan==0)
                  #set($cfRowspan = 1)
                #end

                ##Column 10: ROOT CAUSE
                <td rowspan="$cfRowspan" class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; ">
                        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                        #set($workItemsToLink = [])
                                        #set($countCF=0)
                                        <table height="100%" width="100%" style="border-collapse: collapse;">
                                                <tr >        
                                                <td >
                                                        <table height="100%" width="100%">
                                                        <tr style="vertical-align:bottom;height:5px;">
                                                        <td>
                                                                #RenderWorkItem($CFWi)
                                                                #set($void = $workItemsToLink.add($UEWi))        
                                                        </td>
                                                        </tr>
                                                                <tr style="vertical-align:bottom;height:5px;">
                                                                <td style="vertical-align:bottom;text-align:center;">
                                                                        #renderLinkAndWiCreateEditButtons($CFWi "cfAttr" "causeOfFailure" "backLinked" $linkrole_Causes $documentForWi "no" "Create Root Cause" "Click to Root Cause" $workItemsToLink "")
                                                                        #set($countCF= $countCF +1)
                                                                </td>
                                                                </tr>
                                                        </table>
                                                </td>
                                                </tr>
                                        </table>
                        #else
                                #set($countCF=0)
                                <table height="100%" width="100%" style="border-collapse: collapse;">
                                        <tr >
                                                <td >
                                                        #RenderWorkItem($CFWi)<br>
                                                </td>
                                        </tr>
                                </table>
                        #end
                        
                </td>
                ##Get linked design specification workitems to add rowspan
                #set($srAWiArray = [])
                #set($srAWiArray = $cfsrMap.get($CFWi.getId()))
                        #foreach($SRWi in $srAWiArray)
                                #if($velocityCount>1)
                                        <tr>
                                #end
                                #printSRColumns($lastRevisionNumber $FMWi $UEWi $CFWi $SRWi $documentForWi)
                        #end
                        #if($srAWiArray.size() == 0)
                                #printSRColumns($lastRevisionNumber $FMWi $UEWi $CFWi "" $documentForWi)
                        #end        
        #else
                ## Create new Root cause workitem if not present
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                        #set($workItemsToLink = [])
                        #set($cfRowspan = 1)
                        #set($void = $workItemsToLink.add($UEWi))
                        <td colspan="3" style="padding-left: 20px;">#newWorkItemButton("causeOfFailure" "backLinked" $linkrole_Causes  $documentForWi "no" "Create Root Cause" "Click to Root Cause" $workItemsToLink "")</td>
                #else
                        <td></td>
                        <td></td>
                        <td></td>
                #end
        #end
#end

##Macro to display functions linked to design requirement workitem and highest risk index
#macro(printFMEColumns $lastRevisionNumber $FMWi $pFunRowSpan $documentForWi)

               #set($fmeRowspan = 0 ) 
        #if($FMWi.equals(""))

        #set($workItemsToLink = [])
                $documentForWi doc for wi <br>
            <td colspan="23" style="padding-left: 20px;"> #newWorkItemButton1("function" "" "design" "" $documentForWi  "no" "Create Design Function" "Click to create Design Function" $workItemsToLink "")</td>
        
        #elseif(!$FMWi.equals(""))
                
                #getRowSpansForFs($FMWi $fmeRowspan)
                ##set($fmeRowspan = $fmeRowSpanMap.get($FMWi.getId()))
                        ## Function column

                        ##Column2 : function column 
                            ##set($fmPath = "$FMWi.getReference().toPath()")
                            
                        <td rowspan="$fmeRowspan"  class="polarion-rpw-table-content-row">
                                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                                                <table height="100%" width="100%">
                                                                <tr style="vertical-align:bottom;height:5px;">
                                                                <td>
                                                                        #RenderWorkItem($FMWi)<br>
                                                                        #wiData($FMWi)                                                           
                                                                </td>
                                                                </tr>
                                                                <tr style="vertical-align:bottom;height:5px;">
                                                                <td style="vertical-align:bottom;text-align:center;">
                                                                         #renderLinkAndWiCreateEditButtons1($FMWi "drAttr" "function" "" "design" ""  $documentForWi "no" "Create Design Function " "Click to create Design Function" $workItemsToLink "")
                                                                </td>
                                                                </tr>
                                                </table>
                                        #else
                                                #RenderWorkItem($FMWi)<br>
                                        #end
                        </td>

                        #set($desReqArray = [])
                    #set($desReqArray = $fmeCfdMap.get($FMWi.getId()))
                    #set($uECount = $desReqArray.size())
                    #if($desReqArray.size() == 0)
                                    #printDrColumns($lastRevisionNumber $FMWi "" $documentForWi)
                    #else
                            #foreach($drWi in $desReqArray)
                                    #if($velocityCount>1)
                                            <tr>
                                    #end
                                    #printDrColumns($lastRevisionNumber $FMWi $drWi $documentForWi)
                                   
                            #end
                    #end
                   
        #end
#end


##macro for design requirments j&j

#macro(printDrColumns $lastRevisionNumber $FMWi $drWi $fmDocument )
    
    #set($drRowspan = 0)
    #if($drWi.equals(""))
            
            #set($workItemsToLink = [])
            #set($void = $workItemsToLink.add($FMWi))
            <td colspan="22" style="padding-left: 20px;"> #newWorkItemButton("designRequirement" "backLinked"  $linkrole_Classifies $fmDocument "no" "Create Design Requirement" "Click to createDesign Requirement" $workItemsToLink "")</td>
    #elseif(!$drWi.equals(""))
        #set($drRowspan = 0 )
                #getRowSpansForDR($drWi $drRowspan )
                    
                    
                    ##set($drRowspan = $uecfMap.get($drWi.getId()).size())
                    
            #if($drRowspan == 0)
                #set($drRowspan = 1)
            #end

        <td rowspan="$drRowspan" class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; ">
    
        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                #set($workItemsToLink = [])
                #set($countUN=0)
                <table height="100%" width="100%" style="border-collapse: collapse;">
                    <tr >  
                    <td >
                        <table height="100%" width="100%">
                        <tr style="vertical-align:bottom;height:5px;">
                        <td>
                            #RenderWorkItem($drWi)
                            #set($void = $workItemsToLink.add($FMWi))  
                        </td>
                        </tr>
                                <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #renderLinkAndWiCreateEditButtons($drWi "drAttr" "designRequirement" "backLinked"  $linkrole_Classifies  $fmDocument "no" "Create Design Requirement " "Click to create Design Requirement" $workItemsToLink "")
                                #set($countUN= $countUN +1)
                            </td>
                            </tr>
                        </table>
                    </td>
                    </tr>
                </table>
        #else
                #set($countUN=0)
                <table height="100%" width="100%" style="border-collapse: collapse;">
                    <tr >
                        <td >
                            #RenderWorkItem($drWi)<br>
                        </td>
                    </tr>
                </table>
        #end
    </td>

    <td rowspan="$drRowspan" class="polarion-rpw-table-content-row; " height="100%" width="fit to content" style="text-align: left; ">
          #set($criticalToQuality="")
            #RenderWorkItemField($drWi "criticalToQuality" $criticalToQuality)
            #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                <table height="100%" width="100%">
                        <tr style="vertical-align:bottom;height:5px;">
                        <td>
                            $criticalToQuality
                        </td>
                        </tr>
                        <tr style="vertical-align:bottom;height:5px;">
                        <td style="vertical-align:bottom;text-align:center;">
                            #if(!$criticalToQuality.equals(""))
                                #renderWiEditButtons($drWi "drAttr")
                            #end
                        </td>
                        </tr>
                </table>
            #else
                $criticalToQuality
            #end
            
        </td>
        #*<td rowspan="$drRowspan" > 
            #set($hsForFMs = [] )
            #GetLinkedItems($lastRevisionNumber $drWi "hazardousSituation" "leads" "linkedWorkItems" true "" $hsForFMs )
            #foreach($hs in $hsForFMs)
           
               #RenderWorkItem($hs)  <br><br><br>
            #end
                
           
        </td> *#
        
        
   

        #set($linkedFailMode = [] )
        #GetLinkedItems($lastRevisionNumber $drWi "failureMode" $linkrole_Evaluates "linkedWorkItems" true "" $linkedFailMode )
        #if($linkedFailMode.isEmpty() )
        #printFMcolumns($lastRevisionNumber $drWi "" $fmDocument)
        
        #else
            #foreach($FM in $linkedFailMode)
                    #if($velocityCount>1)
                            <tr>
                    #end
                #printFMcolumns($lastRevisionNumber $drWi $FM $fmDocument)
            #end
        #end
        
    #end



    
    
#end
## macro to calculate highest severity of linked harms to hazardous situation 
#macro(getHighestSeverityHarm $hsForFMs $highestSeverity)
    
   
    #set($harmNeed = "" )
    #set($highestSev = 0 )
    #foreach($hs in $hsForFMs)
        #set($allHarms = [])
        #GetLinkedItems($lastRevisionNumber $hs "harm" "causes" "backlinkedWorkItems" true "AND NOT status:obsolete" $allHarms )
       
        #foreach($harm in $allHarms)
           
            #set($hFieldId = $harm.getCustomField("harmSeverity").getId().trim())
           
            #if($hFieldId )
                #set($hFieldInt = $Integer.parseInt($hFieldId))
                #if($highestSev == 0 )
                  
                    #set($harmNeed = $harm)
                    #set($highestSev = $hFieldInt)
                    
                #elseif($highestSev < $hFieldInt)
                    #set($harmNeed = $harm)
                    #set($highestSev = $hFieldInt)

                      
                #else
                   
                #end
            #end
            
        #end
    #end
    #set($highestSeverity = $harmNeed)
#end

##MACRO TO RENdER FAILURE MODES COLUMNS 
#macro(printFMcolumns $lastRevisionNumber $drWi $fm $fmDocument)
        #set($fmRowspan = 0)
            #getRowSpansForFMs($fm $fmRowspan)
        #if($fm.equals(""))
            
            #set($workItemsToLink = [])
            #set($void = $workItemsToLink.add($drWi))
            <td colspan="20" style="padding-left: 20px;"> #newWorkItemButton("failureMode" "backLinked"  $linkrole_Evaluates $fmDocument "no" "Create failure mode" "Click to create failure mode " $workItemsToLink "")</td>
        #elseif(!$fm.equals(""))
            #if($fmRowspan == 0)
                #set($fmRowspan = 1 )
            #end

        <td rowspan="$fmRowspan" class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; ">
    
        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                #set($workItemsToLink = [])
                #set($countUN=0)
                <table height="100%" width="100%" style="border-collapse: collapse;">
                    <tr >  
                    <td >
                        <table height="100%" width="100%">
                        <tr style="vertical-align:bottom;height:5px;">
                        <td>
                            #RenderWorkItem($fm)
                            #set($void = $workItemsToLink.add($drWi))  
                        </td>
                        </tr>
                                <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                            
                                #renderLinkAndWiCreateEditButtons($fm "fmAttr" "failureMode" "backLinked"  $linkrole_Evaluates  $fmDocument "no" "Create failure mode  " "Click to create failure modee" $workItemsToLink "")
                               
                                #set($countUN= $countUN +1)
                            </td>
                            </tr>
                        </table>
                    </td>
                    </tr>
                </table>
        #else
                #set($countUN=0)
                <table height="100%" width="100%" style="border-collapse: collapse;">
                    <tr >
                        <td >
                            #RenderWorkItem($fm)<br>
                        </td>
                    </tr>
                </table>
        #end
    </td>


    #set($hsForFMs = [] )
        #GetLinkedItems($lastRevisionNumber $fm "hazardousSituation" "leads" "backlinkedWorkItems" true "" $hsForFMs )
        #if($hsForFMs.isEmpty())
            #set($workItemsToLink = [] )
            #set($void = $workItemsToLink.add($fm))
            <td  rowspan="$fmRowspan" style="padding-left: 20px;"> #newWorkItemButton("hazardousSituation" "linked" "leads" $fmDocument "no" "Create Hazardous situation" "Click to create Hazardous situation" $workItemsToLink "")</td>
            
        #else
            <td rowspan="$fmRowspan" class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; ">
                <table height="100%" width="100%" style="border-collapse: collapse;">
                #foreach($hs in $hsForFMs)
                    #set($workItemsToLink = [])
                    #set($countUN=0)
                        <tr >  
                        <td >
                            <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                #RenderWorkItem($hs)
                                #set($void = $workItemsToLink.add($fm))  
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                                <td style="vertical-align:bottom;text-align:center;">
                                    #renderLinkAndWiCreateEditButtons($hs "hsAttr" "hazardousSituation" "linked"  "leads"  $fmDocument "no" "Create hazardous situation  " "Click to create  hazardous situation" $workItemsToLink "")
                                    #set($countUN= $countUN +1)
                                </td>
                            </tr>
							</table>
                        </td>
                        </tr>
                    
                #end
                </table>
            </td>
           
        #end
       
            #set($highestHarm = "" )
            #getHighestSeverityHarm($hsForFMs $highestHarm)
            #if($highestHarm == "" )
                <td rowspan="$fmRowspan" > no severity </td>
            #else
                <td rowspan="$fmRowspan">
                    #set($highestHarmSeverity="")
					#set($highestHarmSeverity=$highestHarm.getValue("harmSeverity"))
					#set($icon = $highestHarm.getValue("harmSeverity").getProperty("iconURL"))
					#set($enumIcon = "<img src = $icon>" )
					
                    #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                        <table height="100%" width="100%">
                                <tr style="vertical-align:bottom;height:5px;">
                                <td>
									#if(!$highestHarmSeverity.equals(""))	
										$enumIcon $highestHarmSeverity.getName()
									#end
                                </td>
                                </tr>
                                <tr style="vertical-align:bottom;height:5px;">
                                <td style="vertical-align:bottom;text-align:center;">
                                    #if(!$highestHarmSeverity.equals(""))
                                        #renderWiEditButtons($highestHarm "hmAttr")
                                    #end
                                </td>
                                </tr>
                        </table>
                    #else
                        #if(!$highestHarmSeverity.equals(""))
							$enumIcon $highestHarmSeverity.getName()
						#end
                    #end
                </td>
            #end


        #if($fm.equals(""))
                <td rowspan="$fmRowspan"></td>
        #else
            <td rowspan="$fmRowspan">
                #set($effectOfFailure="")
                #RenderWorkItemField($fm "effectOfFailure" $effectOfFailure)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $effectOfFailure
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$effectOfFailure.equals(""))
                                    #renderWiEditButtons($fm "fmAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $effectOfFailure
                #end
            </td>
        #end
       

        #set($allRcsForFms = [] )
        #GetLinkedItems($lastRevisionNumber $fm "causeOfFailure" "causes" "linkedWorkItems" true "AND NOT status:obsolete" $allRcsForFms )

        #if($allRcsForFms.isEmpty())
                    #printRcColumns($lastRevisionNumber $fm "" $fmDocument)
        #else
                #foreach($rc in $allRcsForFms)
                        #if($velocityCount>1)
                                <tr>
                        #end
                        #printRcColumns($lastRevisionNumber $fm $rc $fmDocument)
                #end
                

        #end

    
    #end

        


#end

#macro(printRcColumns $lastRevisionNumber $fm $rc $fmDocument )
        #if($rc.equals(""))
            #set($rcRowspan = 0)
            #getRowSpansForFMs($rc $rcRowspan)
            #set($workItemsToLink = [])
            #set($void = $workItemsToLink.add($fm))
            <td colspan="16" style="padding-left: 20px;"> #newWorkItemButton("causeOfFailure" "backLinked"  "causes" $fmDocument "no" "Create root cause" "Click to create root cause " $workItemsToLink "")</td>

        #elseif(!$rc.equals(""))
                #set($dsForRcs = [] )
                #GetLinkedItems($lastRevisionNumber $rc "designSpecification" "controls" "linkedWorkItems" true "AND NOT status:obsolete" $dsForRcs )
               
            #if($dsForRcs.size() == 0)
                #set($rcRowspan = 1 )
            #else
                #set($rcRowspan = $dsForRcs.size())
            #end

        <td rowspan="$rcRowspan" class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; ">
    
        #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                #set($workItemsToLink = [])
                #set($countUN=0)
                <table height="100%" width="100%" style="border-collapse: collapse;">
                    <tr >  
                    <td >
                        <table height="100%" width="100%">
                        <tr style="vertical-align:bottom;height:5px;">
                        <td>
                            #RenderWorkItem($rc)
                            #set($void = $workItemsToLink.add($fm))  
                        </td>
                        </tr>
                                <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #renderLinkAndWiCreateEditButtons($rc "rcAttr" "causeOfFailure" "backLinked"  "causes"  $fmDocument "no" "Create root cause " "Click to create root cause" $workItemsToLink "")
                                #set($countUN= $countUN +1)
                            </td>
                            </tr>
                        </table>
                    </td>
                    </tr>
                </table>
        #else
                #set($countUN=0)
                <table height="100%" width="100%" style="border-collapse: collapse;">
                    <tr >
                        <td >
                            #RenderWorkItem($rc)<br>
                        </td>
                    </tr>
                </table>
        #end
    </td>
    #if($rc.equals(""))
                <td rowspan="$rcRowspan"></td>
                <td rowspan="$rcRowspan"> </td>
        #else
            <td rowspan="$rcRowspan">
                #set($preOccurrence="")
                #RenderWorkItemField($rc "preOccurrence" $preOccurrence)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $preOccurrence
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$preOccurrence.equals(""))
                                    #renderWiEditButtons($rc "rcAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $preOccurrence
                #end
            </td>

            <td rowspan="$rcRowspan">
                #set($postOccurrence="")
                #RenderWorkItemField($rc "postOccurrence" $postOccurrence)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $postOccurrence
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$postOccurrence.equals(""))
                                    #renderWiEditButtons($rc "rcAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $postOccurrence
                #end
            </td>
        #end

        #if($dsForRcs.isEmpty())
            #printDsColums($lastRevisionNumber $rc "" $fmDocument   )

        #else
            #foreach($ds in $dsForRcs )
                #if($velocityCount>1)
                            <tr>
                            
                #end
                #printDsColums($lastRevisionNumber $rc $ds $fmDocument   )
            #end
        #end
    #end
    
#end

#macro(printDsColums $lastRevisionNumber $rc $ds $fmDocument  )
        #if($ds.equals(""))
            
            #set($workItemsToLink = [])
            #set($void = $workItemsToLink.add($rc))
            <td colspan="13" style="padding-left: 20px;"> #newWorkItemButton("designSpecification" "backLinked" "controls" $fmDocument "no" "Create design specification" "Click to create design specification " $workItemsToLink "")</td>
        #elseif(!$ds.equals(""))
             

        <td  class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left; ">
        
            #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    #set($workItemsToLink = [])
                    #set($countUN=0)
                    <table height="100%" width="100%" style="border-collapse: collapse;">
                        <tr >  
                        <td >
                            <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                #RenderWorkItem($ds)
                                #set($void = $workItemsToLink.add($rc))  
                            </td>
                            </tr>
                                    <tr style="vertical-align:bottom;height:5px;">
                                <td style="vertical-align:bottom;text-align:center;">
                                    #renderLinkAndWiCreateEditButtons($ds "dsAttr" "designSpecification" "backLinked"  "controls"  $documentForWi "no" "Create design Specification " "Click to create design specification" $workItemsToLink "")
                                    #set($countUN= $countUN +1)
                                </td>
                                </tr>
                            </table>
                        </td>
                        </tr>
                    </table>
            #else
                    #set($countUN=0)
                    <table height="100%" width="100%" style="border-collapse: collapse;">
                        <tr >
                            <td >
                                #RenderWorkItem($ds)<br>
                            </td>
                        </tr>
                    </table>
            #end
        </td>
        <td  class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left" >

                #set($typeOfControl="")
                #RenderWorkItemField($ds "typeOfControl" $typeOfControl)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $typeOfControl
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$typeOfControl.equals(""))
                                    #renderWiEditButtons($ds "dsAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $typeOfControl
                #end
        </td>
        <td  class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left" >

                #set($evidenceCurrentControls="")
                #RenderWorkItemField($ds "evidenceCurrentControls" $evidenceCurrentControls)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $evidenceCurrentControls
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$evidenceCurrentControls.equals(""))
                                    #renderWiEditButtons($ds "dsAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $evidenceCurrentControls
                #end
        </td>
        <td  class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left" >

                #set($verificationCurrentControls="")
                #RenderWorkItemField($ds "verificationCurrentControls" $verificationCurrentControls)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $verificationCurrentControls
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$verificationCurrentControls.equals(""))
                                    #renderWiEditButtons($ds "dsAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $verificationCurrentControls
                #end
        </td>
        <td  class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left" >

                #set($preDetection="")
                #RenderWorkItemField($ds "preDetection" $preDetection)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $preDetection
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$preDetection.equals(""))
                                    #renderWiEditButtons($ds "dsAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $preDetection
                #end
        </td>

        <td >#set($rpn = "")
            #getPreRPN($ds $rc $highestHarm $rpn )
            $rpn  
        </td>

        #if($rpn < 25)
            #if($rpn != 0)
                <td style="background-color: green;"> yes </td>
            #else
                <td >  Not Calculated </td>
            #end
        #else
            
                <td  style="background-color: red;"> no </td>
            
            
            
        #end

        <td  class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left" >

                #set($recommendedActions="")
                #RenderWorkItemField($ds "recommendedActions" $recommendedActions)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $recommendedActions
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$recommendedActions.equals(""))
                                    #renderWiEditButtons($ds "dsAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $recommendedActions
                #end
        </td>
        <td  class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left" >

                #set($actionsTaken="")
                #RenderWorkItemField($ds "actionsTaken" $actionsTaken)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $actionsTaken
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$actionsTaken.equals(""))
                                    #renderWiEditButtons($ds "dsAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $actionsTaken
                #end
        </td>
        <td  class="polarion-rpw-table-content-row" height="100%" width="fit to content" style="text-align: left" >

                #set($postDetection="")
                
                #RenderWorkItemField($ds "postDetection" $postDetection)
                #if($lastRevisionNumber.equals("") && $readOnlyReport.equals("no"))
                    <table height="100%" width="100%">
                            <tr style="vertical-align:bottom;height:5px;">
                            <td>
                                $postDetection
                            </td>
                            </tr>
                            <tr style="vertical-align:bottom;height:5px;">
                            <td style="vertical-align:bottom;text-align:center;">
                                #if(!$postDetection.equals(""))
                                    #renderWiEditButtons($ds "dsAttr")
                                #end
                            </td>
                            </tr>
                    </table>
                #else
                    $postDetection
                #end
        </td>
        <td> 
           #set($rpn = "")
            #getPostRPN($ds $rc $highestHarm $rpn )
            $rpn 
        </td>
         #if($rpn < 25)
            #if($rpn != 0)
                <td style="background-color: green;"> yes </td>
                <td >Benefits outweigh residual risks </td>
            #else
                <td > Not Calculated </td>
                <td > Not Calculated </td>
            #end
        #else
            <td style="background-color: red;"> no </td>
            <td> RBA Required </td>
        #end

        
   #end
#end

#macro(getPreRPN $ds $rc $harm $rpn)
    #set($rpn = 0)
    
    #set($dsValue = "")
    #set($rcValue = "")
    #set($harmValue = "")

    #if($rc.getCustomField("preOccurrence") && $ds.getCustomField("preDetection") && $harm.getCustomField("harmSeverity") )

        #if($ds.getCustomField("preDetection").getId()  && $ds.getCustomField("preDetection").getId() != "")
            #set($dsValue = $Integer.parseInt($ds.getCustomField("preDetection").getId().trim() ))     
        #end
        #if($rc.getCustomField("preOccurrence") && $rc.getCustomField("preOccurrence").getId() != "")
            #set($rcValue =  $Integer.parseInt($rc.getCustomField("preOccurrence").getId().trim() ))
        #end
        #if($harm.getCustomField("harmSeverity").getId() && $harm.getCustomField("harmSeverity").getId() != "")
            #set($harmValue =  $Integer.parseInt($harm.getCustomField("harmSeverity").getId().trim() ))
        #end
        
        #if($dsValue && $rcValue && $harmValue  )
            #set($rpn = ($dsValue * $rcValue * $harmValue ))
            
        #end
    #end
   
#end 

#macro(getPostRPN $ds $rc $harm $rpn)
    #set($rpn = 0)
     #set($dsValue = "")
    #set($rcValue = "")
     #set($harmValue = "")

    #if($rc.getCustomField("postOccurrence") && $ds.getCustomField("postDetection") && $harm.getCustomField("harmSeverity") )

        #if($ds.getCustomField("postDetection").getId()  && $ds.getCustomField("postDetection").getId() != "")
            #set($dsValue = $Integer.parseInt($ds.getCustomField("postDetection").getId().trim() ))     
        #end
        #if($rc.getCustomField("postOccurrence") && $rc.getCustomField("postOccurrence").getId() != "")
            #set($rcValue =  $Integer.parseInt($rc.getCustomField("postOccurrence").getId().trim() ))
        #end
        #if($harm.getCustomField("harmSeverity").getId() && $harm.getCustomField("harmSeverity").getId() != "")
            #set($harmValue =  $Integer.parseInt($harm.getCustomField("harmSeverity").getId().trim() ))
        #end
        
        #if($dsValue && $rcValue && $harmValue  )
            #set($rpn = ($dsValue * $rcValue * $harmValue ))
            
        #end
    #end
    
#end 

#macro(getRowSpansForFs $FM $rowSpan )
        #set($rowSpan = 0 )
        #set($drsForFs = [] )
        #GetLinkedItems($lastRevisionNumber $FM "designRequirement" $linkrole_Classifies "linkedWorkItems" true "AND NOT status:obsolete" $drsForFs )
       
        
        #if($drsForFs.size() == 0 )
               
                #set($rowSpan = $math.add($rowSpan , 1 ))
        #else
                #foreach($dr in $drsForFs)
                        #set($FmsforDrs = [] )
                        #GetLinkedItems($lastRevisionNumber $dr "failureMode" $linkrole_Evaluates "linkedWorkItems" true "" $FmsforDrs)
                       
                       
                        #if($FmsforDrs.size() == 0 )
                               
                                #set($rowSpan = $math.add($rowSpan,1))
                             
                        #else
                                #foreach($fm in $FmsforDrs)
                                        #set($rcsForFms = [] )
                                        #GetLinkedItems($lastRevisionNumber $fm "causeOfFailure" "causes" "linkedWorkItems" true "AND NOT status:obsolete" $rcsForFms )
                                        #if($rcsForFms.size() == 0 )
                                        
                                                #set($rowSpan = $math.add($rowSpan,1))
                                               
                                        #else
                                                #foreach($rc in $rcsForFms)
                                                        #set($dsforRcs = [] )
                                                        #GetLinkedItems($lastRevisionNumber $rc "designSpecification" "controls" "linkedWorkItems" true "AND NOT status:obsolete" $dsforRcs )
                                                        #if($dsforRcs.size() == 0 )
                                                                #set($rowSpan = $math.add( $rowSpan , 1 ))
                                                        #else
                                                                #set($rowSpan = $math.add($rowSpan , $dsforRcs.size() ))
                                                        #end
                                                #end  
                                        #end
                                #end

                        #end

                #end
        #end

#end

#macro(getRowSpansForDR $dr $rowSpan)
        #set($rowSpan = 0)
         #set($FmsforDrs = [] )
        #GetLinkedItems($lastRevisionNumber $dr "failureMode" $linkrole_Evaluates "linkedWorkItems" true "" $FmsforDrs)
       
        #if($FmsforDrs.size() == 0 )
                
                #set($rowSpan = $math.add($rowSpan,1))
                
        #else
                #foreach($fm in $FmsforDrs)
                        #set($rcsForFms = [] )
                                
                                #GetLinkedItems($lastRevisionNumber $fm "causeOfFailure" "causes" "linkedWorkItems" true "AND NOT status:obsolete" $rcsForFms )
                              
                        #if($rcsForFms.size() == 0 )
                                
                                #set($rowSpan = $math.add($rowSpan,1))
                                
                              
                        #else
                                #foreach($rc in $rcsForFms)
                                        #set($dsforRcs = [] )
                                       
                                        #GetLinkedItems($lastRevisionNumber $rc "designSpecification" "controls" "linkedWorkItems" true "AND NOT status:obsolete" $dsforRcs )
                                        
                                        #if($dsforRcs.size() == 0 )
                                                #set($rowSpan = $math.add($rowSpan , 1 ))

                                               
                                        #else
                                                #set($rowSpan = $math.add($rowSpan , $dsforRcs.size() ))
                                        #end
                                #end  
                        #end
                #end

        #end
       
#end

#macro(getRowSpansForFMs $fm $rowSpan )
              
        #set($rowSpan = 0)
        #set($rcsForFms = [] )
        #GetLinkedItems($lastRevisionNumber $fm "causeOfFailure" "causes" "linkedWorkItems" true "AND NOT status:obsolete" $rcsForFms )
       
        #if($rcsForFms.size() == 0 )
               
                #set($rowSpan = $math.add($rowSpan,1))
                
                
        #else
                #foreach($rc in $rcsForFms)
                        #set($dsforRcs = [] )
                        #GetLinkedItems($lastRevisionNumber $rc "designSpecification" "controls" "linkedWorkItems" true "AND NOT status:obsolete" $dsforRcs )
                       
                        #if($dsforRcs.size() == 0 )
                                #set($rowSpan = $math.add($rowSpan , 1 ))
                               
                        #else
                                #set($rowSpan = $math.add($rowSpan , $dsforRcs.size() ))
                        #end
                #end  
        #end

#end
        



##Macro to update input parametrs
#macro(initScriptToUpdateInputs)

<script type="text/javascript">

        var tableId = "ufmea";
        var prjId = "${projectID}";

        function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
        vars[key] = value;
        } );
        return vars;
    }

        jQuery(function () {
                var nWiId = "";
                nWiId = getUrlVars()["newWiId"];

                if (nWiId.trim().length > 0) {

                        var newItemId = prjId + "/" + nWiId;
                        var cellSe = document.querySelector("div[data-sidebar-item-path='" + newItemId + "']");
                        setTimeout(cellSe.scrollIntoView(true),3000);
                        setTimeout(cellSe.click(),1000);

                        // removing newWiId param value from URL to avoid opening of Wi edit panel second time
                    var singleText = "newWiId";
                        var surl = window.location.toString();
                        if (surl.indexOf(singleText) == -1) {
                                surl +=  "&newWiId=" + newWiId;
                        } else {
                                surl = surl.substring(0,surl.indexOf(singleText)) + "newWiId=" ;
                        }

            let stateObj = { id: "removed new wi id value from url" };
            var pageTitle = document.title;
            window.history.replaceState(stateObj,pageTitle,surl);
                }
        } );

        jQuery(function() {

                // update inputs
                var docName = getUrlVars()["docName"];
                var readOnlyRpt = getUrlVars()["readOnly"];
                var autReload = getUrlVars()["autoReload"];
                var autHide = getUrlVars()["autoHide"];
                var rowHide = getUrlVars()["myRow"];
        
                if (autReload === 'yes' ) {
                        jQuery('#autoReload').prop("checked", true);
                } else if (autReload === 'no') {
                        jQuery('#autoReload').prop("checked", false);
                }

                if (rowHide === 'yes' ) {
                        jQuery('#myRow').prop("checked", true);
                } else if (rowHide === 'no') {
                        jQuery('#myRow').prop("checked", false);
                }

                if (autHide === 'yes' ) {
                        jQuery('#autoHide').prop("checked", true);
                } else if (autHide === 'no') {
                        jQuery('#autoHide').prop("checked", false);
                }

                if (readOnlyRpt === 'yes' ) {
                        jQuery('#readOnly').prop("checked", true);
                        jQuery('#autoReload').prop("checked", false);
                } else {
                        jQuery('#readOnly').prop("checked", false);
                }

                var docNameList = [];
                if (docName) {
                        docNameList = decodeURIComponent(docName).split(',');
                }

                if (docNameList.length > 0) {
                        for(var i = 0; i < docNameList.length; i++) {
                                jQuery("#docdropdown option").each( function() {
                                        if (jQuery(this).val() === docNameList[i]) {
                                           jQuery(this).attr("selected","selected");
                                           jQuery(this).css('background-image','linear-gradient(#4d94ff, #3385ff)');
                                        }
                                } );
                        }
                }
        } );

        // this function is hack to hide left Navigation panel to work in Polarion 20, it may not work in future Polarion releases
        jQuery(function() {
            var autHide = getUrlVars()["autoHide"];
                if (autHide === 'yes' ) {
                    document.querySelector('div.polarion-HideNavigationPanel').click();
            }
        } );
        
        //this function is to show or hide refined requirements
        jQuery(function() {
            var rowHide = getUrlVars()["myRow"];
                if (rowHide === 'yes' ) {
                    $('.myRow').show();
            }
                else{
                  $('.myRow').hide();        
                }
        } );

</script>
#end

##Starting point for report
#if($!urlParameters.size() > 0 )
    #set($baselineRev = "")
    #set($baselineRev = $!urlParameters.baselinerevid.trim())
    #if(!$baselineRev.equals(""))
        #set($lastRevisionNumber = $baselineRev)
                #fmeaTable( $baselineRev $urlParameters )
    #else
            #set($lastRevisionNumber = "")
        #fmeaTable( "" $urlParameters )
    #end
#end
        
## ==========================================================================================================================
## JavaScript
##
## Functions to create work item
## ==========================================================================================================================

<script>
    var newWiId = "";

    function escapeJson (val) {
            var newVal = val.replace(/[\\]/g, '\\\\')
                        .replace(/[\/]/g, '\\/')
                        .replace(/[\b]/g, '\\b')
                        .replace(/[\f]/g, '\\f')
                        .replace(/[\t]/g, '\\t')
                        .replace(/[\"]/g, '\\"')
                        .replace(/\\'/g, "\\'")
                        .replace(/(?:\r\n|\r|\n)/g, '');
                return newVal;
        }

    function createWorkItem(button) {
                var titleField = getClosestChild(getClosestParent(button, 'div'), 'input');
                
                        //disableAllButtons();
                        console.log("Inside the createWorkItem method");
                        var x = button.nextElementSibling;
                        if (x.style.display === 'none') {
                                x.style.display = 'block';
                        } else {
                                x.style.display = 'none';
                        }
                        var rjsonNewWI = [];
                        var wiTypeToBeCreated = button.getAttribute("data_type");
                        var linkRole = button.getAttribute("data_linkrole");
                        var direction = button.getAttribute("data_direction");
                        var docPathWi = escapeJson(button.getAttribute("data_docpath"));
                        var childNode = button.getAttribute("data_addaschild");
            var newTitle = button.getAttribute("data_title");
            console.log("docPathWi:"+docPathWi)
                        var newWIDataObj = {
                                wiType: wiTypeToBeCreated,
                                projectId: "$projectID",
                                docPath: docPathWi,
                                addAsChildNode: childNode,
                                fieldData: [
                                        {
                                                field: "title",
                                                value: []
                                        },
                                        {
                                                field: "description",
                                                value: []
                                        }
                                ]
                        };

                        var titleField = getClosestChild(getClosestParent(button, 'div'), 'input');
            if(titleField.value!="")
                            newWIDataObj.fieldData[0].value[0] = titleField.value;
            else
                newWIDataObj.fieldData[0].value[0] = newTitle;

                        if(titleField.value!="")
                            newWIDataObj.fieldData[1].value[0] = titleField.value;
            else
                newWIDataObj.fieldData[1].value[0] = newTitle;

                        var wiFieldValues = button.getAttribute("data_fieldvalues");
                        if(wiFieldValues.trim().length > 4)
                        {
                                var fieldValuesArr = wiFieldValues.split(",");
                                var len = fieldValuesArr.length;

                                for (var index = 0; index < len; index++)
                                {
                                        var fieldValue = fieldValuesArr[index];
                                        var fieldValueArr = fieldValue.split(":");
                                        var valueArr = [];
                                        valueArr.push(fieldValueArr[1]);
                                        var fieldObj =
                                        {        field: fieldValueArr[0],
                                                value: valueArr
                                        };

                                        newWIDataObj.fieldData.push(fieldObj);
                                }
                        }

                        if(button.getAttribute("data_wis").trim().length > 4)
                        {
                                var wisToLink = button.getAttribute("data_wis").split(";");

                                var linkRoleArr = linkRole.split(";");
                                var directionArr = direction.split(";");

                                var wisToLinkLen = wisToLink.length;
                                for(var i=0; i<wisToLinkLen-1; i++){
                                        var wiToLink = wisToLink[i];
                                        var lnkRole = "";
                                        var direcTion = "";
                                        if(linkRoleArr.length == (wisToLinkLen-1) && directionArr.length == (wisToLinkLen-1)) {
                                                lnkRole = linkRoleArr[i];
                                                direcTion = directionArr[i];
                                        } else {
                                                lnkRole = linkRole;
                                                direcTion = direction;
                                        }
                                        if(wiToLink != ""){
                                                var linkedWIData = {
                                                        field: "linkedWorkItems",
                                                        value: [
                                                                {
                                                                        wiToLink: wiToLink,
                                                                        linkrole: lnkRole,
                                                                        suspect: false,
                                                                        direction: direcTion
                                                                }
                                                        ]
                                                };
                                                newWIDataObj.fieldData.push(linkedWIData);
                                        }
                                }

                                
                        }
                        rjsonNewWI.push(newWIDataObj);

                        createWorkItems(rjsonNewWI);
                
        }

        function createWorkItem1(button) {
                debugger ; 
                var titleField = getClosestChild(getClosestParent(button, 'div'), 'input');
                if(titleField.value=="")
                {
                        alert("Please enter title of workitem.");
                        return;
                }
                else
                {
                        //disableAllButtons();
                        console.log("Inside the createWorkItem method");

                        var x = button.nextElementSibling;
                        if (x.style.display === 'none') {
                                x.style.display = 'block';
                        } else {
                                x.style.display = 'none';
                        }
                        var rjsonNewWI = [];
                        var wiTypeToBeCreated = button.getAttribute("data_type");
                        var linkRole = button.getAttribute("data_linkrole");
                        var direction = button.getAttribute("data_direction");
                        var docPathWi = escapeJson(button.getAttribute("data_docpath"));
                        var childNode = button.getAttribute("data_addaschild");
            var newTitle = button.getAttribute("data_title");
            console.log("docPathWi:"+docPathWi)
                        var newWIDataObj = {
                                wiType: wiTypeToBeCreated,
                                projectId: "$projectID",
                                docPath: docPathWi,
                                addAsChildNode: childNode,
                                fieldData: [
                                        {
                                                field: "title",
                                                value: []
                                        },
                                        {
                                                field: "description",
                                                value: []
                                        }
                                ]
                        };
                        if(wiTypeToBeCreated == "$WORKITEM_TYPE_FUNCTION"){
                 var newTitle = button.getAttribute("data_title");
                var causeLevelData = {
                    field: "subType",
                    value: [
                        newTitle
                    ]
                };
                newWIDataObj.fieldData.push(causeLevelData); 
                        }
                        
                        var titleField = getClosestChild(getClosestParent(button, 'div'), 'input');
                        newWIDataObj.fieldData[0].value[0] = titleField.value;
                        newWIDataObj.fieldData[1].value[0] = titleField.value;
            
                        var wiFieldValues = button.getAttribute("data_fieldvalues");
                        if(wiFieldValues.trim().length > 4)
                        {
                                var fieldValuesArr = wiFieldValues.split(",");
                                var len = fieldValuesArr.length;

                                for (var index = 0; index < len; index++)
                                {
                                        var fieldValue = fieldValuesArr[index];
                                        var fieldValueArr = fieldValue.split(":");
                                        var valueArr = [];
                                        valueArr.push(fieldValueArr[1]);
                                        var fieldObj =
                                        {        field: fieldValueArr[0],
                                                value: valueArr
                                        };

                                        newWIDataObj.fieldData.push(fieldObj);
                                }
                        }

                        if(button.getAttribute("data_wis").trim().length > 4)
                        {
                                var wisToLink = button.getAttribute("data_wis").split(";");

                                var linkRoleArr = linkRole.split(";");
                                var directionArr = direction.split(";");

                                var wisToLinkLen = wisToLink.length;
                                for(var i=0; i<wisToLinkLen-1; i++){
                                        var wiToLink = wisToLink[i];
                                        var lnkRole = "";
                                        var direcTion = "";
                                        if(linkRoleArr.length == (wisToLinkLen-1) && directionArr.length == (wisToLinkLen-1)) {
                                                lnkRole = linkRoleArr[i];
                                                direcTion = directionArr[i];
                                        } else {
                                                lnkRole = linkRole;
                                                direcTion = direction;
                                        }
                                        if(wiToLink != ""){
                                                var linkedWIData = {
                                                        field: "linkedWorkItems",
                                                        value: [
                                                                {
                                                                        wiToLink: wiToLink,
                                                                        linkrole: lnkRole,
                                                                        suspect: false,
                                                                        direction: direcTion
                                                                }
                                                        ]
                                                };
                                                newWIDataObj.fieldData.push(linkedWIData);
                                        }
                                }
                        }
                        rjsonNewWI.push(newWIDataObj);

                        createWorkItems(rjsonNewWI);
                }
        }

        function createWorkItems(rjsonNewWI) {
                if(rjsonNewWI.length != 0) {
                        jQuery.ajax( {
                                type:"POST",
                                url :'/polarion/psorest/createworkitem',
                                data:JSON.stringify(rjsonNewWI),
                                contentType:"application/json; charset=utf-8",
                                dataType:"json",
                                success:function(data) {
                                    if((data.message).indexOf("Success") > -1) {
                                        newWiId = (data.message).split(" - ").pop().trim();
                                        }
                                },
                                failure:function(data) {
                                        alert(data.message);
                                },
                                error:function(XMLHttpRequest, textStatus, errorThrown) { 
                                    if(XMLHttpRequest.status == 404) {
                                                alert("Status: Failed to Create Work Item. Server call not found, this could be due to required plugin deployement issue. Please report this.");
                                        } else {
                                                alert("Status: Failed to Create Work Item. Error: " + errorThrown + ". Please report this");
                                        }
                                },
                                complete:function() {
                                        #if($autoReloadReport.equals("yes"))
                                                var singleText = "newWiId";
                        var surl = window.location.toString();
                                                if (surl.indexOf(singleText) == -1) {
                                                        surl +=  "&newWiId=" + newWiId;
                                                }
                                                else
                                                {
                                                        surl = surl.substring(0,surl.indexOf(singleText)) + "newWiId=" + newWiId;
                                                }
                        jQuery(location).attr('href', surl);
                                        #else
                                                var createWiPanels = document.querySelectorAll('#createwidiv');
                                                createWiPanels.forEach(function(element) {
                                                    element.style.display = 'none';
                                                });
                                        #end
                                }
                        } );
                }
        }

        function disableAllButtons() {
                var buttons = document.getElementsByTagName("BUTTON");
                var buttonsLen = buttons.length;
                for(var k=0; k<buttonsLen; k++) {
                        var buttonToDisable = buttons[k];
                        buttonToDisable.disabled = true;
                }
        }

        function getClosestParent(el, tag) {
                // this is necessary since nodeName is always in upper case
                tag = tag.toUpperCase();
                do {
                        if (el.nodeName === tag) {
                                return el;
                        }
                } while (el = el.parentNode);
                return null;
        }

        function getClosestChild(el, tag) {
                // this is necessary since nodeName is always in upper case
                var tagUpper = tag.toUpperCase();
                var processedChildren = 0;
                do {
                        if (el.nodeName === tagUpper) {
                                return el;
                        } else {
                                var elChildren = el.childNodes;
                                for(var i=0; i<elChildren.length; i++) {
                                        var childEl = elChildren[i];
                                        var wantedEl = getClosestChild(childEl, tagUpper);
                                        if(wantedEl == null) {
                                                processedChildren++;
                                                continue;
                                        } else if (wantedEl.nodeName === tagUpper) {
                                                return wantedEl;
                                        }
                                        processedChildren++;
                                }
                        }
                } while (el.childNodes.length != processedChildren);
                return null;
        }

//create button for workitem with custom field
function createHTMLElement1(imgTag, wiTypeToBeCreated, wiSubType, linkRole, direction, docPath, addAsChild, buttonText, wisString, fieldValueStr ) {
        console.log("inside the createHTML Element function \n");
        var parent = document.createElement("div");
        parent.setAttribute("id","createwidiv");
        parent.setAttribute("style","display: none; text-align: left;");
        var Label= document.createElement("label");
        Label.innerHTML = "Title:";
        parent.appendChild(Label);
        var inputTag = document.createElement("input");
        $(inputTag).attr({type:"text", name:"title", value:""});
        parent.appendChild(inputTag);
        var linebreak = document.createElement("br");
        parent.appendChild(linebreak);
    var button = document.createElement("button");
        $(button).attr({class:"linkTableTD", valign:"middle", data_type:wiTypeToBeCreated, data_title:wiSubType, data_linkrole:linkRole, data_direction:direction, data_docpath:docPath, data_addaschild:addAsChild, data_wis:wisString, data_fieldvalues:fieldValueStr});
        button.innerHTML = buttonText;
        parent.appendChild(button);
        var subDiv = document.createElement("div");
        subDiv.setAttribute("style","display: none;");
        subDiv.setAttribute("align","center");
        parent.appendChild(subDiv);
        var progressTable = document.createElement("table");
        subDiv.appendChild(progressTable);
        var row1 = document.createElement("tr");
        progressTable.appendChild(row1);
        var column1 = document.createElement("td");
        $(column1).attr({align:"center", valign:"middle", width:"100%"});
        row1.appendChild(column1);
        var imgFile = document.createElement("img");
        $(imgFile).attr({src:"/polarion/ria/images/progress.gif", alt:"progress"});
        column1.appendChild(imgFile);
        var row2 = document.createElement("tr");
        progressTable.appendChild(row2);
        var column2 = document.createElement("td");
        column2.innerHTML = "Please Wait ....";
        row2.appendChild(column2);
        imgTag.parentElement.appendChild(parent);
        button.setAttribute("onclick","createWorkItem1(this)");
    var x = imgTag.nextElementSibling;
        if (x.style.display === 'none') {
                x.style.display = 'block';
        } else {
                x.style.display = 'none';
        }
 }
 
 //create button for workitem without custom field
function createHTMLElement(imgTag, wiTypeToBeCreated, linkRole, direction, docPath, addAsChild, buttonText, wisString, fieldValueStr ) {
        console.log("inside the createHTML Element function \n");
        var parent = document.createElement("div");
        parent.setAttribute("id","createwidiv");
        parent.setAttribute("style","display: none; text-align: left;");
        var Label= document.createElement("label");
        Label.innerHTML = "Title:";
        parent.appendChild(Label);
        var inputTag = document.createElement("input");
        $(inputTag).attr({type:"text", name:"title", value:""});
        parent.appendChild(inputTag);
        var linebreak = document.createElement("br");
        parent.appendChild(linebreak);

        var button = document.createElement("button");
        $(button).attr({class:"linkTableTD", valign:"middle", data_type:wiTypeToBeCreated, data_linkrole:linkRole, data_direction:direction, data_docpath:docPath, data_addaschild:addAsChild, data_wis:wisString, data_fieldvalues:fieldValueStr});
        button.innerHTML = buttonText;
        parent.appendChild(button);
        var subDiv = document.createElement("div");
        subDiv.setAttribute("style","display: none;");
        subDiv.setAttribute("align","center");
        parent.appendChild(subDiv);
        var progressTable = document.createElement("table");
        subDiv.appendChild(progressTable);
        var row1 = document.createElement("tr");
        progressTable.appendChild(row1);
        var column1 = document.createElement("td");
        $(column1).attr({align:"center", valign:"middle", width:"100%"});
        row1.appendChild(column1);
        var imgFile = document.createElement("img");
        $(imgFile).attr({src:"/polarion/ria/images/progress.gif", alt:"progress"});
        column1.appendChild(imgFile);
        var row2 = document.createElement("tr");
        progressTable.appendChild(row2);
        var column2 = document.createElement("td");
        column2.innerHTML = "Please Wait ....";
        row2.appendChild(column2);
        imgTag.parentElement.appendChild(parent);
        button.setAttribute("onclick","createWorkItem1(this)");
        var x = imgTag.nextElementSibling;
        if (x.style.display === 'none') {
                x.style.display = 'block';
        } else {
                x.style.display = 'none';
        }
 }

var storedLinkInfo = [];             // global variable to store selected/clicked Wi information
var swap = false;                    // swap to identify the linking direction while passing the workitem ids to Ajax call
var isWorkItemLinked = false;        // to identify while closing link-panel pop-up if the workitem is already linked or not

//function to create close dialog box
function closeLinkDialog()
{
    $("#add_WI_Link").hide();
        $("#add_WI_Link").removeClass('polarion_LinkPanel_popup_done');
        storedLinkInfo = [];
        swap = false;
        isWorkItemLinked = false;
        document.getElementById("polarion-LinkPanel-hintContainer").style.visibility = "visible";
        var problemContainerTag = document.getElementById("polarion_LinkPanel_problem");
        var searchTargetWI = document.getElementById("searchTargetWI");
        searchTargetWI.style.display = 'none';
        problemContainerTag.style.display = 'none';
        var imgLink = document.getElementsByClassName("polarion-LinkActions");
        var len = imgLink.length;
        var i = 0;
        for(i=0; i<len; i++) {
            imgLink[i].style.backgroundColor = 'buttonface';
    }
}

$(".close").click(function()
{  if (!isWorkItemLinked) {
            if (confirm("Discard Changes?")) {
                        txt = "You pressed OK!";
                        closeLinkDialog();
                        var txt;
            } else {
                   txt = "You pressed Cancel!";
            }
    } else {
            closeLinkDialog();
    }
});

//function to list all allowable link roles
function listOutAllPossibleLinkRoles() {
        var pri = storedLinkInfo[2];
        var links = "$workItemLinkRoleList";
        links = links.split("+++");
        links.pop();
        var len = links.length;
        var i;
        var j;
    for(i=0; i<len; i++) {
                var link1 = links.shift();
                link1 = link1.split(":");
                var link2 = link1.shift();
                link2 = link1.shift();
                link2 = (new String(link2));
                link1 = (new String(link1));
                if(link2.search(pri) >= 0 && link2 == pri ) {
                        var links1 = link1.split(";");
                        links1.pop();
                        var select = document.getElementById("linkRoles");
                        while (select.hasChildNodes()) {
                          select.removeChild(select.firstChild);
                        }
                        var lens = links1.length;
                        for(j = 0; j < lens; j++) {
                          var option = document.createElement("option");
                          var ship = links1.shift();
                          var id_Name = ship.split("=");
                          option.value = id_Name.shift();
                          option.text = id_Name;
                          select.appendChild(option);
                        }
                }
    }
    // below foreach loop to remove repeated linkRole opitons
    var seen = [];
    jQuery('#linkRoles').children().each(function() {
        var txt = jQuery(this).attr('value');
        if (seen[txt]) {
           jQuery(this).remove();
        } else {
           seen[txt] = true;
        }
    } );
}

function linkroleList() {
  if(storedLinkInfo != "") {
    var pri = storedLinkInfo[2];
    var sec = storedLinkInfo[5];
    var links = "$workItemLinks";  // catching all allowed LinkRole and wiType combination
    links = links.split("+++");
    links.pop();
    var len = links.length;
    var i;
    var j;
    for(i=0; i<len; i++) {
      var link1 = links.shift();
      link1 = link1.split(":");
      var link2 = link1.shift();
      link2 = link1.shift();
      link2 = (new String(link2));
      var link3 = link1.shift();
      link3 = (new String(link3));
      link1 = (new String(link1));
      if(link2.search(pri) >= 0 && link2 == pri ) {
        if(link3.search(sec) >= 0 && link3 == sec ) {
          var links1 = link1.split(";");
          links1.pop();
          var select = document.getElementById("linkRoles");
          while (select.hasChildNodes()) {
            select.removeChild(select.firstChild);
          }
          var lens = links1.length;
          for(j = 0; j < lens; j++) {
            var option = document.createElement("option");
            var ship = links1.shift();
            var id_Name = ship.split("=");
            option.value = id_Name.shift();
            option.text = id_Name;
            select.appendChild(option);
          }
        }
      }
    }
    var populatedList = document.getElementById("linkRoles");
    var problem = document.getElementById("polarion_LinkPanel_problem");
    if(populatedList.hasChildNodes()) {
      problem.style.display = 'none';
      jQuery("#add_WI_Link").removeClass('polarion_LinkPanel_popup');
      jQuery("#add_WI_Link").addClass('polarion_LinkPanel_popup_done');
      document.getElementById("polarion-LinkPanel-hintContainer").style.visibility = "hidden";
      document.getElementById("polarion_Button_save").style.display = 'block';
      checkLinkDirection();
    } else {
       problem.style.display = 'block';
    }
  }
}

//function to select workitem using workItemPicker
function workItemPicker() {
  var selectedLinkRole = document.getElementById("linkRoles");
  var value = selectedLinkRole.options[selectedLinkRole.selectedIndex].value;
  var projectVal = storedLinkInfo[1];
  var workitemType = storedLinkInfo[2];
  var searchTargetWI = document.getElementById("searchTargetWI");
  if (searchTargetWI.style.display == 'none') {
    searchTargetWI.style.display = 'block';
  }

  $('#selectTargetWI').empty(); //empties workitem dropdown list before selecting another link role
  document.getElementById("searchTargetWI").value = ""; // empties the searchable input field

  jQuery.ajax( {
                        url: "/polarion/psorest/getWorkItemsForSelectedTypeAndLinkRole",
                        cache: false,
                        type: "GET",
                        data: {
                                type: workitemType,
                                projectId: projectVal,
                                linkRole : value,
                        }
                } ).done(function(data) {
                        if(data.status.toLowerCase().includes("success")) {
                                var select = document.getElementById("selectTargetWI");
                                var queriedWI = data.workItems;
                                var i;
                                var len = queriedWI.length;
                                if(len == 0) {
                                  var option = document.createElement("option");
                                  option.text = "No workitems Found";
                                  select.appendChild(option);
                                }
                                for(i=0; i<len; i++) {
                                  var option = document.createElement("option");
                                  var workItem = queriedWI[i];
                                  var property = workItem.split(";");
                                  var id = property.shift();
                                  var title = property.shift();
                                  var id_title = "";
                                  id_title = id.concat(" ").concat(title);
                                  $(option).attr({dataToPass:workItem});
                                  option.text = id_title;
                                  select.appendChild(option);
                                }
                        } else if (data.status.toLowerCase().includes("failed")) {
                                swal("Error", data.message, "");
                        }
                } ).error (function(xhr, status, error) {
                    var err = JSON.parse(xhr.responseText);
                        swal("Error", err.message, "error");
        } );
}

//function to check link direction
function checkLinkDirection() {
  console.log("inside checkLinkDirection");
  var linkRole = document.getElementById("linkRoles");
  var text = linkRole.options[linkRole.selectedIndex].text;
  var oppositeNames = "$linkOppositeNameList";
  var oppositeNames = oppositeNames.split(":");
  var linkArrowImgTag = document.getElementById("polarion-LinkPanel-linkArrow");
  var len = oppositeNames.length;
  var i = 1;
  var flag = false;
  for (i=1; i<= len; i++) {
      if(text == oppositeNames[i]) {
        var srcURL = "/polarion/ria/images/linking/arrow_up.png";
        linkArrowImgTag.src = "";
        linkArrowImgTag.src = srcURL;
        flag = true;
        swap = true;
      }
  }
  if(!flag) {
    var srcURL = "/polarion/ria/images/linking/arrow_down.png";
    linkArrowImgTag.src = "";
    linkArrowImgTag.src = srcURL;
    swap = false;
    console.log(swap);
  }
}

//function to create link between workitems
function createLink(creatlinkTag) {
    if(storedLinkInfo.length == 0) {
                var childWi_id = creatlinkTag.getAttribute("wiId");
                var project_id= creatlinkTag.getAttribute("wiProject");
                var projectName = creatlinkTag.getAttribute("wiProjectName");
                var workItem_type = creatlinkTag.getAttribute("wiType");
                var workItem_imgSrcFrom = creatlinkTag.getAttribute("iconURL");
                storedLinkInfo.push(childWi_id);
                storedLinkInfo.push(project_id);
                storedLinkInfo.push(workItem_type);
                document.getElementById("polarion_LinkPanel_title").innerHTML = "Linking " + storedLinkInfo[0];
                document.getElementById("polarion_LinkPanel_fromWiIcon").src = workItem_imgSrcFrom;
                document.getElementById("polarion_LinkPanel_fromLabel").innerHTML = "from " + projectName;
                document.getElementById("polarion_LinkPanel_selectWorkitem").style.display = 'block';
                document.getElementById("polarion_LinkPanel_toWiIcon").src = "";
                document.getElementById("polarion_LinkPanel_toWiId").innerHTML = "";
                document.getElementById("polarion_Button_saved").style.display = 'none';
                document.getElementById("polarion_Button_save").style.display = 'none';
                jQuery("#add_WI_Link").removeClass('polarion_LinkPanel_popup_done_final');
                jQuery("#add_WI_Link").addClass('polarion_LinkPanel_popup');
                jQuery("#add_WI_Link").show();
                creatlinkTag.style.backgroundColor = '#cccccc';
                listOutAllPossibleLinkRoles();
    } else if (storedLinkInfo.length > 5) {   // for restricting user from selecting multiple link WIs while link panel popup is on display
        alert("Please save the linking panel before starting a new link.");
    } else if (storedLinkInfo.length != 0 ) {
                var searchTargetWI = document.getElementById("searchTargetWI");
                if (searchTargetWI.style.display == 'block') {
                searchTargetWI.style.display = 'none';
                }
                var tagName = creatlinkTag.tagName;

                // if workitem selected from dropdown list else workitem is selected using link buttion icon
                if(tagName == "INPUT") {
                        var value = document.getElementById("searchTargetWI").value;
                        var dataList = document.getElementById("selectTargetWI");
                        var options = dataList.children;
                        //console.log(options);
                        var len = options.length;
                        var i = 0;
                        var optElement = "";
                        for(i=0; i<len; i++) {
                                var opt = options[i];
                                var val = opt.value;
                                if(value == val){
                                   //console.log(val);
                                   optElement = opt;
                                }
                        }
                        var optAttribute = optElement.getAttribute("dataToPass");
                        console.log(optAttribute);
                        var value = optAttribute;
                        var properties = value.split(";");
                        var parentWi_id = properties.shift();
                        var title = properties.shift();
                        var project_id = properties.shift();
                        var workItem_typeP = properties.shift();
                        var workItem_imgSrcTo = properties.shift();
                        storedLinkInfo.push(parentWi_id);
                        storedLinkInfo.push(project_id);
                        storedLinkInfo.push(workItem_typeP);
                } else {
                        var parentWi_id = creatlinkTag.getAttribute("wiId");
                        var project_id= creatlinkTag.getAttribute("wiProject");
                        var workItem_typeP = creatlinkTag.getAttribute("wiType");
                        var workItem_imgSrcTo = creatlinkTag.getAttribute("iconURL");
                        storedLinkInfo.push(parentWi_id);
                        storedLinkInfo.push(project_id);
                        storedLinkInfo.push(workItem_typeP);
                        creatlinkTag.style.backgroundColor = '#cccccc';
        }
                console.log("global storedLinkInfo array : "+storedLinkInfo)
                document.getElementById("polarion_Button_saved").style.display = 'none';
                document.getElementById("polarion_LinkPanel_selectWorkitem").style.display = 'none';
                document.getElementById("polarion_LinkPanel_toWiIcon").src = workItem_imgSrcTo;
                document.getElementById("polarion_LinkPanel_toWiId").innerHTML = " " + storedLinkInfo[3];

                linkroleList();   // calling linkroleList to populate all possible linkRoles for selected workitem type
    }
}

$("#createLinks").click( function() {
        var role = document.getElementById("linkRoles").value;
        console.log("Selected link role id : "+role);
        document.getElementById("add_WI_Linkheader").style.display = 'none';
        document.getElementById("loadingDiv").style.display = 'block';
        var arrayPreIndex = 0;
        var arrayPostIndex = 3;
        // check if linking is direct or backlink, if backlink then values will be swaped i.e to to From type instead of from type to to type
    if (swap) {
                console.log("is direct linkrole :" + swap);
                var arrayPreIndex = 3;
                var arrayPostIndex = 0;
    }
        var childWi = "";
        var childWi = storedLinkInfo[1];
        childWi = childWi.concat("/");
        childWi = childWi.concat(storedLinkInfo[arrayPreIndex]);
        var parentWi = "";
        parentWi = storedLinkInfo[1];
        parentWi = parentWi.concat("/");
        parentWi = parentWi.concat(storedLinkInfo[arrayPostIndex]);
        var rjsonNewWI = [];
        var newWIDataObj = {
                child: childWi,
                project: storedLinkInfo[1],
                parents: [
                        {
                                id: parentWi,
                                linkrole: role,
                                revision: null,
                                suspect: false
                        }
                  ]
    };
    rjsonNewWI.push(newWIDataObj);
    linkWorkItems(rjsonNewWI);  // calling linkWorkItems() an ajax call
} );

function linkWorkItems(rjsonNewWI) {
        if(rjsonNewWI.length != 0) {
                jQuery.ajax( {
                        type:"POST",
                        url :'/polarion/psorest/createlink',
                        data:JSON.stringify(rjsonNewWI),
                        contentType:"application/json; charset=utf-8",
                        dataType:"json",
                        success:function(data){},
                        failure:function(data){
                                alert(data.message);
                        },
                        error:function(XMLHttpRequest, textStatus, errorThrown) { 
                            if (XMLHttpRequest.status == 404) {
                                        alert("Status: Failed to Create Work Item. Server call not found, this could be due to required plugin deployement issue. Please report this.");
                                } else {
                                        alert("Status: Failed to Create Work Item. Error: " + errorThrown + ". Please report this");
                                }
                        },
                        complete:function() {
                                processAjaxCalls();
                        }
                } );
        }
}

function processAjaxCalls() {
        // process  Work-item linking(Ajax call to java plugin) without page refresh
        document.getElementById("loadingDiv").style.display = 'none';
        //$("#add_WI_Link").hide();
        $("#add_WI_Link").removeClass('polarion_LinkPanel_popup_done');
        $("#add_WI_Link").addClass('polarion_LinkPanel_popup_done_final');
        storedLinkInfo = [];
        swap = false;
        var imgLink = document.getElementsByClassName("polarion-LinkActions");
        var len = imgLink.length;
        var i = 0;
        for(i=0; i<len; i++) {
          imgLink[i].style.backgroundColor = 'buttonface';
        }
        var newTitle = document.getElementById("polarion_LinkPanel_title").innerHTML;
        var value = newTitle.replace("Linking", "Linked");
        document.getElementById("polarion_LinkPanel_title").innerHTML = value;
        document.getElementById("polarion_Button_saved").style.display = 'block';
        document.getElementById("polarion_Button_save").style.display = 'none';
        document.getElementById("add_WI_Linkheader").style.display = 'block';
        setTimeout(closeLinkDialog, 2000);
}

dragElement(document.getElementById("add_WI_Link"));

function dragElement(elmnt) {
    var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    if (document.getElementById(elmnt.id + "dragable")) {
        // if present, the header is where you move the DIV from:
        document.getElementById(elmnt.id + "dragable").onmousedown = dragMouseDown;
    } else {
        // otherwise, move the DIV from anywhere inside the DIV:
        //elmnt.onmousedown = dragMouseDown;
    }

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        // get the mouse cursor position at startup:
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        // call a function whenever the cursor moves:
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        // calculate the new cursor position:
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        // set the elements new position:
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        // stop moving when mouse button is released:
        document.onmouseup = null;
        document.onmousemove = null;
    }
}
</script>

<script>
function resetSortImage(cloumn, projectId) {
        if (cloumn == 1) {
                document.getElementById("sortRiskIndexFlagPre").value = "None";
                document.getElementById("sortRiskIndexPre").src = "/polarion/icons/project/" + projectId + "/sort_UpDown.png";

                document.getElementById("sortRiskIndexFlagPost").value = "None";
                document.getElementById("sortRiskIndexPost").src = "/polarion/icons/project/" + projectId + "/sort_UpDown.png";
        }

        if (cloumn == 2) {
                document.getElementById("sortRiskIndexFlagPost").value = "None";
                document.getElementById("sortRiskIndexPost").src = "/polarion/icons/project/" + projectId + "/sort_UpDown.png";

                document.getElementById("sortRiskIndexFlagPre").value = "None";
                document.getElementById("sortRiskIndexPre").src = "/polarion/icons/project/" + projectId + "/sort_UpDown.png";
        }
}

//Function to sort column data
function sortfunction(cloumn, sortflag, sort, projectId) {
        
        var table, rows, switching, i, x, y, shouldSwitch;
        table = document.getElementById("ufmea");
        switching = true;
        var flagStatus = document.getElementById(sortflag).value;
        console.log("Flag Status:"+ flagStatus);
        while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length); i++) {
                        shouldSwitch = false;
                        if (i + 1 == (rows.length)) break;
                        x = rows[i].cells[cloumn];
                        y = rows[i + 1].cells[cloumn];
                        if (flagStatus == "None" || flagStatus == "Down") {
                                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                                        shouldSwitch = true;
                            console.log("shouldSwitch:"+ shouldSwitch);
                                        break;
                                }

                        } else {
                                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                        shouldSwitch = true;
                                        break;
                                }
                        }
                }
                if (shouldSwitch) {
                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                }
        }
        if (flagStatus == "None" || flagStatus == "Down") {
                document.getElementById(sort).src = "/polarion/icons/project/" + projectId + "/sort-up.png";
                document.getElementById(sortflag).value = "Up";
        } else {
                document.getElementById(sort).src = "/polarion/icons/project/" + projectId + "/sort-down.png";
                document.getElementById(sortflag).value = "Down";
        }

        resetSortImage(cloumn, projectId);
}

//Function for keyword search
$('#myInput').on('keyup', function() {
  var value = $(this).val();
  var patt = new RegExp(value, "i");

  $('#myTableBody').children().each(function() {
        if (!($(this).children().text().search(patt) >= 0)) {
        $(this).not('.polarion-rpw-table-content-row').hide();
    }
    if (($(this).children().text().search(patt) >= 0)) {
      $(this).show();
    }

  });

});


</script>
<script type="text/javascript">
//Function to show or hide column
function hide_show_table(col_name)
{
 var checkbox_val=document.getElementById(col_name).value;
 if(checkbox_val=="dontShow")
 {
  var all_col=document.getElementsByClassName(col_name);
  for(var i=0;i<all_col.length;i++)
  {
   all_col[i].style.display="none";
  }
  //document.getElementById(col_name).style.display="none";
  document.getElementById(col_name).value="show";
 }
        
 else
 {
  var all_col=document.getElementsByClassName(col_name);
  for(var i=0;i<all_col.length;i++)
  {
   all_col[i].style.display="table-row";
  }
  document.getElementById(col_name).style.display="table-row";
  document.getElementById(col_name).value="dontShow";
 }
}

//Function to keep radio button checked on selection and to enable or disable View Current version Button
$(function() {
        if($!urlParameters.size() > 0 )
        {
                var btn1 = document.querySelector(".button1");
                btn1.disabled = true;
                if(!$radioId.equals("") ){
                var rID="$radioId";
                document.getElementById(rID).checked=true;
                 btn1.disabled = false;
                }
                else{
                btn1.disabled = true;
                }
        }
});
$(function() {
        if($!urlParameters.size() > 0 )
        {
                var btn2 = document.getElementById("button$lr");

                btn2.disabled = true;
                
        }
});
</script>
<script>
//Function to save state of selection of input parameters
(function() {
   var cbstate;
  
  // bind to the onload event
  window.addEventListener('load', function() {
    // Get the current state from localstorage
    // State is stored as a JSON string
    cbstate = JSON.parse(localStorage['CBState'] || '{}');
  
    // Loop through state array and restore checked 
    // state for matching elements
    for(var i in cbstate) {
      var el = document.querySelector('input[name="' + i + '"]');
      if (el) el.checked = true;
    }
  
    // Get all checkboxes that you want to monitor state for
    var cb = document.getElementsByClassName('save-cb-state');
  
    // Loop through results and ...
    for(var i = 0; i < cb.length; i++) {
  
      //bind click event handler
      cb[i].addEventListener('click', function(evt) {
        // If checkboxe is checked then save to state
        if (this.checked) {
          cbstate[this.name] = true;
        }
    
    // Else remove from state
        else if (cbstate[this.name]) {
          delete cbstate[this.name];
        }
    
    // Persist state
        localStorage.CBState = JSON.stringify(cbstate);
      });
    }
  });
})();
</script>